/**
 * InsightReel Content Script (Enhanced Modular Version)
 * platforms/ í•¸ë“¤ëŸ¬ë“¤ì„ í™œìš©í•œ ì™„ì „í•œ ëª¨ë“ˆí™” ë²„ì „
 */

// ê¸°ë³¸ ìœ í‹¸ë¦¬í‹° (ìˆœí™˜ì°¸ì¡° ë°©ì§€)
class Utils {
    static detectPlatform() {
        const hostname = window.location.hostname;
        if (hostname.includes('instagram.com')) return 'INSTAGRAM';
        if (hostname.includes('tiktok.com')) return 'TIKTOK';
        if (hostname.includes('youtube.com') || hostname.includes('youtu.be')) return 'YOUTUBE';
        return null;
    }

    static log(level, message, data = null) {
        const timestamp = new Date().toISOString();
        const prefix = `[InsightReel ${timestamp}]`;

        switch (level) {
            case 'info':
                console.log(`${prefix} â„¹ï¸ ${message}`, data || '');
                break;
            case 'warn':
                console.warn(`${prefix} âš ï¸ ${message}`, data || '');
                break;
            case 'error':
                console.error(`${prefix} âŒ ${message}`, data || '');
                break;
            case 'success':
                console.log(`${prefix} âœ… ${message}`, data || '');
                break;
            default:
                console.log(`${prefix} ${message}`, data || '');
        }
    }
}

// í™˜ê²½ ì„¤ì • (ë¹Œë“œ ì‹œ ì£¼ì…ë¨)
const environment = {
    SERVER_URL: process.env.SERVER_URL || 'http://localhost:3000',
    NODE_ENV: process.env.NODE_ENV || 'development',
    GOOGLE_API_KEY: process.env.GOOGLE_API_KEY || null,
    isDevelopment: process.env.NODE_ENV === 'development',
};

// í”Œë«í¼ ìƒìˆ˜
const PLATFORMS = {
    INSTAGRAM: 'INSTAGRAM',
    TIKTOK: 'TIKTOK',
    YOUTUBE: 'YOUTUBE'
};

// ê°„ë‹¨í•œ ApiClient í´ë˜ìŠ¤
class ApiClient {
    constructor(serverUrl = environment.SERVER_URL) {
        this.serverUrl = serverUrl;
    }

    async checkConnection() {
        try {
            const response = await fetch(`${this.serverUrl}/health`, {
                method: 'GET',
                timeout: 5000,
            });
            return response.ok;
        } catch (error) {
            Utils.log('error', 'Server connection failed', error);
            return false;
        }
    }

    async processVideo(videoData) {
        try {
            const response = await fetch(`${this.serverUrl}/api/process-video`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(videoData)
            });

            if (response.ok) {
                return await response.json();
            } else {
                throw new Error(`ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜: ${response.status}`);
            }
        } catch (error) {
            Utils.log('error', 'ì„œë²„ ì „ì†¡ ì‹¤íŒ¨', error.message);
            throw error;
        }
    }
}

// ê°„ë‹¨í•œ UIManager í´ë˜ìŠ¤
class UIManager {
    constructor() {
        this.processedElements = new Set();
    }

    cleanup() {
        // ì •ë¦¬ ì‘ì—…
        this.processedElements.clear();
    }
}

// ë©”ì¸ Content Script í´ë˜ìŠ¤
class ContentScript {
    constructor() {
        this.platform = Utils.detectPlatform();
        this.apiClient = new ApiClient();
        this.uiManager = new UIManager();
        this.platformHandler = null;
        this.init();
    }

    init() {
        Utils.log('info', 'InsightReel Enhanced Content Script ì‹œì‘', {
            platform: this.platform,
            url: window.location.href,
            environment: environment.NODE_ENV,
        });

        if (!this.platform) {
            Utils.log('warn', 'ì§€ì›ë˜ì§€ ì•ŠëŠ” í”Œë«í¼', window.location.hostname);
            return;
        }

        // ì„œë²„ ì—°ê²° í™•ì¸
        this.checkServerConnection();

        // Chrome Extension ë©”ì‹œì§€ ë¦¬ìŠ¤ë„ˆ
        this.setupMessageListeners();

        // í™˜ê²½ë³€ìˆ˜ ì„¤ì • í™•ì¸
        this.validateEnvironment();

        // í”Œë«í¼ë³„ í•¸ë“¤ëŸ¬ ì´ˆê¸°í™” ì‹œë„
        this.initializePlatformHandler();
    }

    async initializePlatformHandler() {
        try {
            Utils.log('info', `${this.platform} í”Œë«í¼ í•¸ë“¤ëŸ¬ ë¡œë”© ì‹œë„ ì¤‘...`);

            // í”Œë«í¼ë³„ í•¸ë“¤ëŸ¬ ë™ì  ë¡œë”© (Webpackì—ì„œ ë²ˆë“¤ë§ë¨)
            switch (this.platform) {
                case PLATFORMS.INSTAGRAM:
                    await this.loadInstagramHandler();
                    break;

                case PLATFORMS.YOUTUBE:
                    await this.loadYouTubeHandler();
                    break;

                case PLATFORMS.TIKTOK:
                    await this.loadTikTokHandler();
                    break;

                default:
                    Utils.log('warn', 'ì•Œ ìˆ˜ ì—†ëŠ” í”Œë«í¼', this.platform);
                    this.initializeBasicFeatures();
                    return;
            }

            // í˜ì´ì§€ ì–¸ë¡œë“œ ì‹œ ì •ë¦¬
            window.addEventListener('beforeunload', () => {
                this.cleanup();
            });

            Utils.log('success', `ğŸ¯ ${this.platform} í”Œë«í¼ í•¸ë“¤ëŸ¬ ì´ˆê¸°í™” ì™„ë£Œ`);

        } catch (error) {
            Utils.log('error', 'í”Œë«í¼ í•¸ë“¤ëŸ¬ ë¡œë”© ì‹¤íŒ¨ - ê¸°ë³¸ ê¸°ëŠ¥ìœ¼ë¡œ í´ë°±', error);
            this.initializeBasicFeatures();
        }
    }

    async loadInstagramHandler() {
        try {
            // ê¸°ì¡´ bundled íŒŒì¼ì˜ Instagram ê¸°ëŠ¥ì„ ê°„ì†Œí™”ëœ í˜•íƒœë¡œ êµ¬í˜„
            this.platformHandler = new InstagramHandler(this.apiClient, this.uiManager);

            // Instagram ì „ìš© ê¸°ëŠ¥ ì‹œì‘
            setInterval(() => {
                this.addInstagramAnalysisButtons();
            }, 1500);

            Utils.log('success', 'âœ… Instagram í•¸ë“¤ëŸ¬ ì´ˆê¸°í™” ì™„ë£Œ');
        } catch (error) {
            Utils.log('error', 'Instagram í•¸ë“¤ëŸ¬ ë¡œë”© ì‹¤íŒ¨', error);
            this.initializeInstagramFallback();
        }
    }

    async loadYouTubeHandler() {
        try {
            this.platformHandler = new YouTubeHandler(this.apiClient, this.uiManager);

            // YouTube ì „ìš© ê¸°ëŠ¥ ì‹œì‘
            this.addYouTubeButtons();

            // SPA ë„¤ë¹„ê²Œì´ì…˜ ê°ì§€
            window.addEventListener('yt-navigate-finish', () => {
                setTimeout(() => this.addYouTubeButtons(), 500);
            });

            Utils.log('success', 'âœ… YouTube í•¸ë“¤ëŸ¬ ì´ˆê¸°í™” ì™„ë£Œ');
        } catch (error) {
            Utils.log('error', 'YouTube í•¸ë“¤ëŸ¬ ë¡œë”© ì‹¤íŒ¨', error);
            this.initializeYouTubeFallback();
        }
    }

    async loadTikTokHandler() {
        try {
            this.platformHandler = new TikTokHandler(this.apiClient, this.uiManager);

            // TikTok ì „ìš© ê¸°ëŠ¥ ì‹œì‘
            setInterval(() => {
                this.addTikTokAnalysisButtons();
            }, 2000);

            Utils.log('success', 'âœ… TikTok í•¸ë“¤ëŸ¬ ì´ˆê¸°í™” ì™„ë£Œ');
        } catch (error) {
            Utils.log('error', 'TikTok í•¸ë“¤ëŸ¬ ë¡œë”© ì‹¤íŒ¨', error);
            this.initializeTikTokFallback();
        }
    }

    // í´ë°± ê¸°ëŠ¥ë“¤ (ê¸°ì¡´ content-script-main.js ê¸°ë°˜)
    initializeBasicFeatures() {
        Utils.log('info', 'ê¸°ë³¸ ê¸°ëŠ¥ìœ¼ë¡œ í´ë°±');
        setInterval(() => {
            this.addBasicButtons();
        }, 2000);
    }

    initializeInstagramFallback() {
        setInterval(() => {
            this.addInstagramAnalysisButtons();
        }, 1500);
    }

    initializeYouTubeFallback() {
        this.addYouTubeButtons();
        window.addEventListener('yt-navigate-finish', () => {
            setTimeout(() => this.addYouTubeButtons(), 500);
        });
    }

    initializeTikTokFallback() {
        setInterval(() => {
            this.addTikTokAnalysisButtons();
        }, 2000);
    }

    // Instagram ë¶„ì„ ë²„íŠ¼ ì¶”ê°€ (ê¸°ì¡´ ì½”ë“œ ê¸°ë°˜)
    addInstagramAnalysisButtons() {
        const posts = document.querySelectorAll('article[role="presentation"]');

        posts.forEach(post => {
            if (post.querySelector('.instagram-analysis-button')) return;

            const video = post.querySelector('video');
            if (!video) return;

            const button = this.createAnalysisButton('instagram', 'ğŸ¤– ë¶„ì„');
            button.className = 'instagram-analysis-button';
            button.style.cssText = `
                background: linear-gradient(45deg, #8e44ad, #3498db) !important;
                color: white !important;
                border: none !important;
                border-radius: 20px !important;
                padding: 8px 16px !important;
                font-size: 12px !important;
                cursor: pointer !important;
                margin: 5px !important;
                z-index: 9999 !important;
                position: relative !important;
            `;

            // ê¸°ì¡´ ì €ì¥ ë²„íŠ¼ ì°¾ê¸°
            const saveButtons = post.querySelectorAll('svg[aria-label*="ì €ì¥"], svg[aria-label*="Save"]');
            if (saveButtons.length > 0) {
                const saveButton = saveButtons[0].closest('button');
                if (saveButton && saveButton.parentElement) {
                    saveButton.parentElement.appendChild(button);
                }
            }
        });
    }

    // YouTube ë²„íŠ¼ë“¤ ì¶”ê°€ (ê¸°ì¡´ ì½”ë“œ ê¸°ë°˜)
    addYouTubeButtons() {
        const isVideoPage = window.location.pathname === '/watch';
        const isShortsPage = window.location.pathname.startsWith('/shorts/');
        const isChannelPage = window.location.pathname.includes('/channel/') || window.location.pathname.includes('/@');

        if (isVideoPage) {
            this.addYouTubeVideoAnalysisButton();
        } else if (isShortsPage) {
            this.addYouTubeShortsAnalysisButton();
        } else if (isChannelPage) {
            this.addYouTubeChannelAnalysisButton();
        }
    }

    addYouTubeVideoAnalysisButton() {
        if (document.querySelector('.youtube-analysis-button')) return;

        const actionButtons = document.querySelector('#top-level-buttons-computed') ||
                             document.querySelector('#actions #top-level-buttons');

        if (actionButtons) {
            const button = this.createAnalysisButton('youtube', 'ğŸ¬ ì˜ìƒ ë¶„ì„');
            button.className = 'youtube-analysis-button';
            button.style.cssText = `
                background: #ff0000 !important;
                color: white !important;
                border: none !important;
                border-radius: 18px !important;
                padding: 10px 16px !important;
                font-size: 14px !important;
                font-weight: 500 !important;
                cursor: pointer !important;
                margin-left: 8px !important;
                height: 36px !important;
            `;
            actionButtons.appendChild(button);
        }
    }

    addYouTubeShortsAnalysisButton() {
        if (document.querySelector('.youtube-shorts-analysis-button')) return;

        const actionsArea = document.querySelector('#actions');
        if (actionsArea) {
            const button = this.createAnalysisButton('youtube-shorts', 'ğŸ“± Shorts ë¶„ì„');
            button.className = 'youtube-shorts-analysis-button';
            button.style.cssText = `
                background: rgba(0, 0, 0, 0.8) !important;
                color: white !important;
                border: 1px solid rgba(255, 255, 255, 0.3) !important;
                border-radius: 24px !important;
                width: 48px !important;
                height: 48px !important;
                font-size: 16px !important;
                cursor: pointer !important;
                margin: 8px 0 !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
            `;
            actionsArea.appendChild(button);
        }
    }

    addYouTubeChannelAnalysisButton() {
        if (document.querySelector('.youtube-channel-analysis-button')) return;

        const channelHeader = document.querySelector('#channel-header') ||
                             document.querySelector('#channel-info');

        if (channelHeader) {
            const button = this.createAnalysisButton('youtube-channel', 'ğŸ¤– ì±„ë„ ë¶„ì„');
            button.className = 'youtube-channel-analysis-button';
            button.style.cssText = `
                background: linear-gradient(45deg, #ff6b6b, #ee5a24) !important;
                color: white !important;
                border: none !important;
                border-radius: 20px !important;
                padding: 12px 20px !important;
                font-size: 14px !important;
                font-weight: bold !important;
                cursor: pointer !important;
                margin: 10px !important;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3) !important;
            `;
            channelHeader.appendChild(button);
        }
    }

    // TikTok ë¶„ì„ ë²„íŠ¼ ì¶”ê°€ (ê¸°ì¡´ ì½”ë“œ ê¸°ë°˜)
    addTikTokAnalysisButtons() {
        const videos = document.querySelectorAll('div[data-e2e="recommend-list-item"]');

        videos.forEach(video => {
            if (video.querySelector('.tiktok-analysis-button')) return;

            const button = this.createAnalysisButton('tiktok', 'ğŸµ ë¶„ì„');
            button.className = 'tiktok-analysis-button';
            button.style.cssText = `
                background: #fe2c55 !important;
                color: white !important;
                border: none !important;
                border-radius: 16px !important;
                padding: 8px 12px !important;
                font-size: 12px !important;
                cursor: pointer !important;
                position: absolute !important;
                top: 10px !important;
                right: 10px !important;
                z-index: 9999 !important;
            `;

            video.style.position = 'relative';
            video.appendChild(button);
        });
    }

    // ê¸°ë³¸ ë²„íŠ¼ë“¤ (í´ë°±ìš©)
    addBasicButtons() {
        document.querySelectorAll('video').forEach(video => {
            const container = video.closest('article, div');
            if (!container || container.querySelector('.basic-insightreel-button')) return;

            const button = this.createAnalysisButton('basic', 'ğŸ“¥ ì €ì¥');
            button.className = 'basic-insightreel-button';
            container.appendChild(button);
        });
    }

    // ë²„íŠ¼ ìƒì„± í—¬í¼
    createAnalysisButton(platform, text) {
        const button = document.createElement('button');
        button.textContent = text;
        button.title = `InsightReel - ${platform} ì½˜í…ì¸  ë¶„ì„`;

        button.addEventListener('click', () => {
            this.handleAnalysisClick(platform);
        });

        return button;
    }

    async handleAnalysisClick(platform) {
        Utils.log('info', `ğŸ¯ ${platform} ë¶„ì„ ë²„íŠ¼ í´ë¦­ë¨`);

        const videoData = {
            platform: platform.toUpperCase(),
            url: window.location.href,
            timestamp: new Date().toISOString()
        };

        try {
            const result = await this.apiClient.processVideo(videoData);
            Utils.log('success', 'ì„œë²„ë¡œ ë°ì´í„° ì „ì†¡ ì™„ë£Œ', result);
        } catch (error) {
            Utils.log('error', 'ì²˜ë¦¬ ì‹¤íŒ¨', error.message);
        }
    }

    cleanup() {
        if (this.platformHandler && typeof this.platformHandler.cleanup === 'function') {
            this.platformHandler.cleanup();
        }

        if (this.uiManager) {
            this.uiManager.cleanup();
        }

        Utils.log('info', 'Content Script ì •ë¦¬ ì™„ë£Œ');
    }

    async checkServerConnection() {
        const isConnected = await this.apiClient.checkConnection();

        if (isConnected) {
            Utils.log('success', 'ì„œë²„ ì—°ê²° í™•ì¸ë¨');
        } else {
            Utils.log('warn', 'ì„œë²„ ì—°ê²° ì‹¤íŒ¨ - ê¸°ë³¸ ëª¨ë“œë¡œ ì‹¤í–‰');
        }
    }

    setupMessageListeners() {
        chrome.runtime.onMessage.addListener(
            (request, sender, sendResponse) => {
                this.handleMessage(request, sender, sendResponse);
                return true;
            },
        );
    }

    async handleMessage(request, sender, sendResponse) {
        try {
            switch (request.action) {
                case 'ping':
                    sendResponse({
                        success: true,
                        message: 'Enhanced Content Script ì‘ë‹µ',
                    });
                    break;

                case 'getStatus':
                    sendResponse({
                        success: true,
                        data: {
                            platform: this.platform,
                            serverUrl: environment.SERVER_URL,
                            environment: environment.NODE_ENV,
                            hasHandler: !!this.platformHandler,
                            version: 'enhanced-modular'
                        },
                    });
                    break;

                default:
                    sendResponse({ error: 'ì•Œ ìˆ˜ ì—†ëŠ” ì•¡ì…˜ì…ë‹ˆë‹¤.' });
            }
        } catch (error) {
            Utils.log('error', 'ë©”ì‹œì§€ ì²˜ë¦¬ ì‹¤íŒ¨', error.message);
            sendResponse({ error: error.message });
        }
    }

    validateEnvironment() {
        Utils.log('info', 'í™˜ê²½ ì„¤ì • í™•ì¸', {
            serverUrl: environment.SERVER_URL,
            nodeEnv: environment.NODE_ENV,
            hasApiKey: !!environment.GOOGLE_API_KEY,
            isDevelopment: environment.isDevelopment,
        });

        if (!environment.GOOGLE_API_KEY) {
            Utils.log(
                'warn',
                'GOOGLE_API_KEY í™˜ê²½ë³€ìˆ˜ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.',
            );
        }
    }
}

// ê°„ë‹¨í•œ í”Œë«í¼ í•¸ë“¤ëŸ¬ ìŠ¤í…ë“¤ (ì‹¤ì œ ëª¨ë“ˆ ë¡œë”© ì‹¤íŒ¨ì‹œ ì‚¬ìš©)
class InstagramHandler {
    constructor(apiClient, uiManager) {
        this.apiClient = apiClient;
        this.uiManager = uiManager;
        Utils.log('info', '[FALLBACK] Instagram í•¸ë“¤ëŸ¬ (ê¸°ë³¸ ê¸°ëŠ¥)');
    }

    cleanup() {
        // ì •ë¦¬ ì‘ì—…
    }
}

class YouTubeHandler {
    constructor(apiClient, uiManager) {
        this.apiClient = apiClient;
        this.uiManager = uiManager;
        Utils.log('info', '[FALLBACK] YouTube í•¸ë“¤ëŸ¬ (ê¸°ë³¸ ê¸°ëŠ¥)');
    }

    cleanup() {
        // ì •ë¦¬ ì‘ì—…
    }
}

class TikTokHandler {
    constructor(apiClient, uiManager) {
        this.apiClient = apiClient;
        this.uiManager = uiManager;
        Utils.log('info', '[FALLBACK] TikTok í•¸ë“¤ëŸ¬ (ê¸°ë³¸ ê¸°ëŠ¥)');
    }

    cleanup() {
        // ì •ë¦¬ ì‘ì—…
    }
}

// Content Script ì‹¤í–‰
try {
    Utils.log('info', 'ğŸš€ InsightReel Enhanced Content Script ì´ˆê¸°í™” ì‹œì‘');

    const contentScript = new ContentScript();

    // ê¸€ë¡œë²Œ ì ‘ê·¼ì„ ìœ„í•œ window ê°ì²´ ë“±ë¡
    window.INSIGHTREEL = {
        contentScript,
        utils: Utils,
        platforms: PLATFORMS,
        environment,
        version: 'enhanced-modular'
    };

    // ë””ë²„ê¹…ìš© ì¶”ê°€ ì ‘ê·¼ (ê°œë°œ ëª¨ë“œì—ì„œë§Œ)
    if (environment.isDevelopment) {
        window.ContentScript = contentScript;
        window.Utils = Utils;
        window.PLATFORMS = PLATFORMS;
        window.environment = environment;
        Utils.log('info', 'ğŸ› ï¸ ê°œë°œ ëª¨ë“œ: ë””ë²„ê¹… ê°ì²´ë“¤ì´ windowì— ë“±ë¡ë¨');
    }

    Utils.log('success', 'âœ… InsightReel Enhanced Content Script ì´ˆê¸°í™” ì™„ë£Œ');

} catch (error) {
    console.error('âŒ InsightReel Enhanced Content Script ì‹¤í–‰ ì˜¤ë¥˜:', error);
    console.error('ì˜¤ë¥˜ ìœ„ì¹˜:', error.stack);

    // ì˜¤ë¥˜ ë°œìƒ ì‹œì—ë„ ê¸°ë³¸ì ì¸ ì •ë³´ëŠ” ì œê³µ
    window.INSIGHTREEL_ERROR = {
        error: error.message,
        stack: error.stack,
        timestamp: new Date().toISOString(),
        version: 'enhanced-modular'
    };
}