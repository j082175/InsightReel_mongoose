(()=>{const t={SERVER_URL:"http://localhost:3000",NODE_ENV:"production",GOOGLE_API_KEY:null,isDevelopment:!1},e={INSTAGRAM:"INSTAGRAM",TIKTOK:"TIKTOK",YOUTUBE:"YOUTUBE"};class n{static detectPlatform(){const t=window.location.hostname;return t.includes("instagram.com")?"INSTAGRAM":t.includes("tiktok.com")?"TIKTOK":t.includes("youtube.com")||t.includes("youtu.be")?"YOUTUBE":null}static log(t,e,n=null){const o=`[InsightReel ${(new Date).toISOString()}]`;switch(t){case"info":console.log(`${o} ℹ️ ${e}`,n||"");break;case"warn":console.warn(`${o} ⚠️ ${e}`,n||"");break;case"error":console.error(`${o} ❌ ${e}`,n||"");break;case"success":console.log(`${o} ✅ ${e}`,n||"");break;default:console.log(`${o} ${e}`,n||"")}}}const o={mediaData:{},mediaIdMap:{},fbIdMap:{},init(){this.setupNetworkInterception(),this.extractFromPageData(),n.log("success","🔥 Instagram Media Tracker 초기화 완료")},setupNetworkInterception(){const t=this,e=XMLHttpRequest.prototype.open,n=XMLHttpRequest.prototype.send;XMLHttpRequest.prototype.open=function(t,n,...o){return this._url=n,e.apply(this,arguments)},XMLHttpRequest.prototype.send=function(e){return this.addEventListener("load",function(){if(this.status>=200&&this.status<300)try{if(this.responseURL.includes("/graphql/query")){const e=JSON.parse(this.responseText);t.processGraphQLResponse(e)}else if(this.responseURL.includes("/api/v1/media/")&&this.responseURL.includes("/info/")){const e=JSON.parse(this.responseText);t.processMediaInfoResponse(e)}else if(this.responseURL.includes("/api/v1/feed/")){const e=JSON.parse(this.responseText);t.processFeedResponse(e)}}catch(t){}}),n.apply(this,arguments)}},processGraphQLResponse(t){this.extractMediaFromAnyLevel(t)},processMediaInfoResponse(t){t.items&&t.items.forEach(t=>this.storeMediaInfo(t))},processFeedResponse(t){t.items&&t.items.forEach(t=>{t.media?this.storeMediaInfo(t.media):this.storeMediaInfo(t)})},storeMediaInfo(t){var e,o,i,a,s,r,l;if(null==t||!t.code||null==t||!t.like_count)return;const c=t.code;if(this.mediaData[c])return void this.updateExistingMedia(this.mediaData[c],t);const d={code:c,created_at:(null==t||null===(e=t.caption)||void 0===e?void 0:e.created_at)||(null==t?void 0:t.taken_at),like_count:t.like_count,comment_count:t.comment_count,play_count:(null==t?void 0:t.ig_play_count)||(null==t?void 0:t.play_count)||(null==t?void 0:t.view_count),username:(null==t||null===(o=t.caption)||void 0===o||null===(o=o.user)||void 0===o?void 0:o.username)||(null==t||null===(i=t.owner)||void 0===i?void 0:i.username)||(null==t||null===(a=t.user)||void 0===a?void 0:a.username),video_url:null==t||null===(s=t.video_versions)||void 0===s||null===(s=s[0])||void 0===s?void 0:s.url,img_origin:null==t||null===(r=t.image_versions2)||void 0===r||null===(r=r.candidates)||void 0===r||null===(r=r[0])||void 0===r?void 0:r.url};null!=t&&t.carousel_media&&(d.carousel_media=t.carousel_media.map(t=>{var e,n;return[null==t||null===(e=t.video_versions)||void 0===e||null===(e=e[0])||void 0===e?void 0:e.url,null==t||null===(n=t.image_versions2)||void 0===n||null===(n=n.candidates)||void 0===n||null===(n=n[0])||void 0===n?void 0:n.url]}).flat().filter(t=>t).join("\n")),this.mediaData[c]=d,t.id&&(this.mediaIdMap[t.id]=c),t.pk&&(this.fbIdMap[t.pk]=c),t.video_id&&(this.fbIdMap[t.video_id]=c),t.fb_video_id&&(this.fbIdMap[t.fb_video_id]=c),n.log("info","📱 미디어 정보 저장됨",{shortcode:c,url:(null===(l=d.video_url)||void 0===l?void 0:l.substring(0,50))+"...",hasCarousel:!!d.carousel_media})},updateExistingMedia(t,e){var n,o,i;!t.video_url&&null!=e&&null!==(n=e.video_versions)&&void 0!==n&&null!==(n=n[0])&&void 0!==n&&n.url&&(t.video_url=e.video_versions[0].url),!t.created_at&&(null!=e&&null!==(o=e.caption)&&void 0!==o&&o.created_at||null!=e&&e.taken_at)&&(t.created_at=(null===(i=e.caption)||void 0===i?void 0:i.created_at)||e.taken_at)},extractMediaFromAnyLevel(t,e=0){if(!(e>15)&&t&&"object"==typeof t){t.code&&t.like_count&&this.storeMediaInfo(t),t.data&&this.processDataSection(t.data);for(const n in t)t.hasOwnProperty(n)&&t[n]&&"object"==typeof t[n]&&this.extractMediaFromAnyLevel(t[n],e+1)}},processDataSection(t){var e,n,o;null!==(e=t.xdt_api__v1__feed__timeline__connection)&&void 0!==e&&e.edges&&t.xdt_api__v1__feed__timeline__connection.edges.forEach(t=>{var e;null!==(e=t.node)&&void 0!==e&&e.media&&this.storeMediaInfo(t.node.media)}),null!==(n=t.xdt_api__v1__clips__home__connection_v2)&&void 0!==n&&n.edges&&t.xdt_api__v1__clips__home__connection_v2.edges.forEach(t=>{var e;null!==(e=t.node)&&void 0!==e&&e.media?this.storeMediaInfo(t.node.media):t.node&&this.storeMediaInfo(t.node)}),null!==(o=t.xdt_api__v1__media__shortcode__web_info)&&void 0!==o&&o.items&&t.xdt_api__v1__media__shortcode__web_info.items.forEach(t=>{this.storeMediaInfo(t)})},extractFromPageData(){const t=document.querySelectorAll('script[type="application/json"]');for(const e of t)try{const t=JSON.parse(e.textContent);this.extractMediaFromAnyLevel(t)}catch(t){}},getMediaInfoForCurrentVideo(){const t=window.location.href.match(/\/p\/([A-Za-z0-9_-]+)|\/reel\/([A-Za-z0-9_-]+)|\/reels\/([A-Za-z0-9_-]+)/),e=t?t[1]||t[2]||t[3]:null;if(e&&this.mediaData[e])return n.log("info","🎯 URL에서 미디어 발견:",e),this.mediaData[e];const o=Object.values(this.mediaData).filter(t=>t.video_url).sort((t,e)=>(e.created_at||0)-(t.created_at||0))[0];return o?(n.log("info","🎯 최근 비디오 미디어 사용:",o.code),o):null}};class i{constructor(){this.isAnalyzing=!1,this.channelButton=null,this.init()}init(){n.log("info","🎥 YouTube 채널 분석기 초기화"),this.checkForChannelPage(),this.observeURLChanges()}observeURLChanges(){let t=location.href;new MutationObserver(()=>{location.href!==t&&(t=location.href,setTimeout(()=>this.checkForChannelPage(),1e3))}).observe(document,{subtree:!0,childList:!0})}isChannelPage(){const t=window.location.href;return t.includes("/channel/")||t.includes("/@")||t.includes("/c/")||t.includes("/user/")}checkForChannelPage(){this.isChannelPage()?this.waitForChannelHeader():this.removeAnalyzeButton()}waitForChannelHeader(){let t=0;const e=()=>{t++;const o=document.querySelector("#channel-name, .ytd-channel-name, #text-container h1"),i=document.querySelector("#subscriber-count, .ytd-subscriber-count");o&&i?this.addAnalyzeButton():t<10?setTimeout(e,1e3):n.log("warn","⚠️ 채널 헤더를 찾을 수 없음")};e()}addAnalyzeButton(){this.removeAnalyzeButton();const t=document.querySelector("#subscribe-button, .ytd-subscribe-button-renderer");if(!t)return void n.log("warn","⚠️ 구독 버튼을 찾을 수 없어 버튼 위치 결정 실패");this.channelButton=document.createElement("button"),this.channelButton.textContent="🤖 채널 분석",this.channelButton.className="youtube-channel-analysis-button",this.channelButton.style.cssText="\n            background: linear-gradient(45deg, #ff6b6b, #ee5a24) !important;\n            color: white !important;\n            border: none !important;\n            border-radius: 20px !important;\n            padding: 12px 20px !important;\n            font-size: 14px !important;\n            font-weight: bold !important;\n            cursor: pointer !important;\n            margin: 10px !important;\n            box-shadow: 0 4px 12px rgba(0,0,0,0.3) !important;\n        ",this.channelButton.addEventListener("click",()=>{this.analyzeChannel()});const e=t.closest("#subscribe-button")||t.parentElement;e&&(e.appendChild(this.channelButton),n.log("success","✅ YouTube 채널 분석 버튼 추가됨"))}removeAnalyzeButton(){const t=document.querySelector(".youtube-channel-analysis-button");t&&t.remove(),this.channelButton=null}async analyzeChannel(){if(this.isAnalyzing)n.log("warn","이미 분석 중입니다");else{this.isAnalyzing=!0,this.updateButtonState(!0);try{const e=this.extractChannelData();if(!e)return void n.log("error","채널 데이터를 추출할 수 없습니다");n.log("info","🎯 채널 분석 시작",e);const o=await fetch(`${t.SERVER_URL}/api/process-channel`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({platform:"YOUTUBE",type:"channel",data:e,url:window.location.href,timestamp:(new Date).toISOString()})});if(o.ok){const t=await o.json();n.log("success","✅ 채널 분석 완료",t)}else n.log("error","❌ 서버 응답 오류",o.status)}catch(t){n.log("error","❌ 채널 분석 실패",t.message)}finally{this.isAnalyzing=!1,this.updateButtonState(!1)}}}extractChannelData(){var t,e,n,o,i;const a=null===(t=document.querySelector("#channel-name .ytd-channel-name, #text-container h1"))||void 0===t||null===(t=t.textContent)||void 0===t?void 0:t.trim(),s=null===(e=document.querySelector("#subscriber-count, .ytd-subscriber-count"))||void 0===e||null===(e=e.textContent)||void 0===e?void 0:e.trim(),r=null===(n=document.querySelector("#description-content, .ytd-channel-about-metadata-renderer"))||void 0===n||null===(n=n.textContent)||void 0===n?void 0:n.trim(),l=window.location.href;return{name:a,id:(null===(o=l.match(/\/channel\/([^\/\?]+)/))||void 0===o?void 0:o[1])||(null===(i=l.match(/\/@([^\/\?]+)/))||void 0===i?void 0:i[1]),subscribers:s,description:r,url:l}}updateButtonState(t){this.channelButton&&(this.channelButton.textContent=t?"🔄 분석중...":"🤖 채널 분석",this.channelButton.disabled=t,this.channelButton.style.cursor=t?"not-allowed":"pointer")}}const a={processedElements:new Set,scanInterval:null,init(){n.log("info","🎨 Instagram UI System 시작"),this.startScanning(),this.scanForMedia()},startScanning(){this.scanInterval=setInterval(()=>{this.scanForMedia()},1500)},scanForMedia(){n.log("info","🔍 Instagram 미디어 스캔 시작");const t=['article[role="presentation"]',"article",'div[role="presentation"]','[data-testid="post-item"]','div[style*="flex-direction"]'];let e=0;for(const o of t){const t=document.querySelectorAll(o);if(n.log("info",`🎯 셀렉터 "${o}": ${t.length}개 발견`),t.forEach(t=>{if(this.processedElements.has(t))return;const o=t.querySelector("video"),i=t.querySelector('img[src*="scontent"], img[src*="cdninstagram"], img[src*="instagram"], img[alt]'),a="ARTICLE"===t.tagName;(o||i||a)&&(this.addAnalysisButton(t),this.processedElements.add(t),e++,n.log("info",`📍 버튼 추가: ${o?"비디오":i?"이미지":"Article"} 포스트`))}),e>0){n.log("success",`✅ ${e}개 포스트에 버튼 추가됨`);break}}0===e&&(n.log("warn","⚠️ Instagram 포스트를 찾을 수 없음 - DOM 구조 변경 가능성"),this.debugDOMStructure())},debugDOMStructure(){const t=document.querySelectorAll("article"),e=document.querySelectorAll("div[role]"),o=document.querySelectorAll("video");n.log("info","📊 DOM 구조 분석:",{articles:t.length,divsWithRole:e.length,videos:o.length,url:window.location.href})},addAnalysisButton(t){if(t.querySelector(".instagram-analysis-button"))return;const e=document.createElement("button");e.textContent="🤖 분석",e.className="instagram-analysis-button",e.style.cssText="\n            background: linear-gradient(45deg, #8e44ad, #3498db) !important;\n            color: white !important;\n            border: none !important;\n            border-radius: 20px !important;\n            padding: 8px 16px !important;\n            font-size: 12px !important;\n            font-weight: bold !important;\n            cursor: pointer !important;\n            margin: 5px !important;\n            z-index: 9999 !important;\n            position: absolute !important;\n            top: 10px !important;\n            right: 10px !important;\n            box-shadow: 0 2px 8px rgba(0,0,0,0.3) !important;\n        ",e.addEventListener("click",()=>{this.analyzeInstagramMedia()});let o=!1;const i=['svg[aria-label*="저장"], svg[aria-label*="Save"]','svg[aria-label*="Bookmark"]','[data-testid="save-button"]','[role="button"][aria-label*="Save"]'];for(const a of i){const i=t.querySelectorAll(a);if(i.length>0){const t=i[0].closest("button");if(t&&t.parentElement){t.parentElement.appendChild(e),o=!0,n.log("success",`✅ 저장 버튼 근처에 분석 버튼 추가됨 (${a})`);break}}}return o||(t.style.position="relative",t.appendChild(e),o=!0,n.log("success","✅ 포스트 상단에 분석 버튼 추가됨 (폴백 방식)")),o},async analyzeInstagramMedia(){n.log("info","🎯 Instagram 미디어 분석 시작");try{const e=o.getMediaInfoForCurrentVideo();if(!e)return void n.log("warn","현재 미디어 정보를 찾을 수 없습니다");const i=await fetch(`${t.SERVER_URL}/api/process-video`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({platform:"INSTAGRAM",type:"video",data:e,url:window.location.href,timestamp:(new Date).toISOString()})});if(i.ok){const t=await i.json();n.log("success","✅ Instagram 미디어 분석 완료",t)}else n.log("error","❌ 서버 응답 오류",i.status)}catch(t){n.log("error","❌ Instagram 미디어 분석 실패",t.message)}},cleanup(){this.scanInterval&&clearInterval(this.scanInterval),this.processedElements.clear()}},s={init(){this.addYouTubeButtons(),window.addEventListener("yt-navigate-finish",()=>{setTimeout(()=>this.addYouTubeButtons(),500)})},addYouTubeButtons(){const t="/watch"===window.location.pathname,e=window.location.pathname.startsWith("/shorts/");t?this.addYouTubeVideoAnalysisButton():e&&this.addYouTubeShortsAnalysisButton()},addYouTubeVideoAnalysisButton(){if(document.querySelector(".youtube-analysis-button"))return;const t=document.querySelector("#top-level-buttons-computed")||document.querySelector("#actions #top-level-buttons");if(t){const e=document.createElement("button");e.textContent="🎬 영상 분석",e.className="youtube-analysis-button",e.style.cssText="\n                background: #ff0000 !important;\n                color: white !important;\n                border: none !important;\n                border-radius: 18px !important;\n                padding: 10px 16px !important;\n                font-size: 14px !important;\n                font-weight: 500 !important;\n                cursor: pointer !important;\n                margin-left: 8px !important;\n                height: 36px !important;\n            ",e.addEventListener("click",()=>{this.analyzeYouTubeVideo()}),t.appendChild(e),n.log("success","✅ YouTube 영상 분석 버튼 추가됨")}},addYouTubeShortsAnalysisButton(){if(document.querySelector(".youtube-shorts-analysis-button"))return;const t=document.querySelector("#actions");if(t){const e=document.createElement("button");e.textContent="📱",e.title="Shorts 분석",e.className="youtube-shorts-analysis-button",e.style.cssText="\n                background: rgba(0, 0, 0, 0.8) !important;\n                color: white !important;\n                border: 1px solid rgba(255, 255, 255, 0.3) !important;\n                border-radius: 24px !important;\n                width: 48px !important;\n                height: 48px !important;\n                font-size: 16px !important;\n                cursor: pointer !important;\n                margin: 8px 0 !important;\n                display: flex !important;\n                align-items: center !important;\n                justify-content: center !important;\n            ",e.addEventListener("click",()=>{this.analyzeYouTubeVideo(!0)}),t.appendChild(e),n.log("success","✅ YouTube Shorts 분석 버튼 추가됨")}},async analyzeYouTubeVideo(e=!1){n.log("info",`🎯 YouTube ${e?"Shorts":"영상"} 분석 시작`);try{const o=this.extractVideoData(),i=await fetch(`${t.SERVER_URL}/api/process-video`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({platform:"YOUTUBE",type:e?"shorts":"video",data:o,url:window.location.href,timestamp:(new Date).toISOString()})});if(i.ok){const t=await i.json();n.log("success","✅ YouTube 영상 분석 완료",t)}else n.log("error","❌ 서버 응답 오류",i.status)}catch(t){n.log("error","❌ YouTube 영상 분석 실패",t.message)}},extractVideoData(){var t,e;return{videoId:this.extractYouTubeId(window.location.href),title:null===(t=document.querySelector("h1.ytd-video-primary-info-renderer, #title h1"))||void 0===t||null===(t=t.textContent)||void 0===t?void 0:t.trim(),channelName:null===(e=document.querySelector("#channel-name a, .ytd-channel-name a"))||void 0===e||null===(e=e.textContent)||void 0===e?void 0:e.trim(),url:window.location.href}},extractYouTubeId(t){const e=t.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/shorts\/)([^&\n?#]+)/);return e?e[1]:null}};class r{constructor(){this.platform=n.detectPlatform(),this.init()}init(){n.log("info","🚀 InsightReel Complete Content Script 시작",{platform:this.platform,url:window.location.href,environment:t.NODE_ENV}),this.platform?(this.setupMessageListeners(),this.initializePlatformFeatures(),window.addEventListener("beforeunload",()=>{this.cleanup()}),n.log("success",`✅ ${this.platform} 플랫폼 기능 초기화 완료`)):n.log("warn","지원되지 않는 플랫폼",window.location.hostname)}initializePlatformFeatures(){switch(this.platform){case e.INSTAGRAM:window.INSTAGRAM_MEDIA_TRACKER=o,o.init(),window.INSTAGRAM_UI_SYSTEM=a,setTimeout(()=>a.init(),1e3);break;case e.YOUTUBE:window.youtubeChannelAnalyzer=new i,s.init();break;case e.TIKTOK:this.initializeTikTok()}}initializeTikTok(){setInterval(()=>{this.addTikTokAnalysisButtons()},2e3)}addTikTokAnalysisButtons(){document.querySelectorAll('div[data-e2e="recommend-list-item"]').forEach(t=>{if(t.querySelector(".tiktok-analysis-button"))return;const e=document.createElement("button");e.textContent="🎵 분석",e.className="tiktok-analysis-button",e.style.cssText="\n                background: #fe2c55 !important;\n                color: white !important;\n                border: none !important;\n                border-radius: 16px !important;\n                padding: 8px 12px !important;\n                font-size: 12px !important;\n                cursor: pointer !important;\n                position: absolute !important;\n                top: 10px !important;\n                right: 10px !important;\n                z-index: 9999 !important;\n            ",e.addEventListener("click",()=>{this.analyzeTikTokVideo()}),t.style.position="relative",t.appendChild(e)})}async analyzeTikTokVideo(){n.log("info","🎯 TikTok 영상 분석 시작");try{const e=await fetch(`${t.SERVER_URL}/api/process-video`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({platform:"TIKTOK",type:"video",url:window.location.href,timestamp:(new Date).toISOString()})});if(e.ok){const t=await e.json();n.log("success","✅ TikTok 영상 분석 완료",t)}else n.log("error","❌ 서버 응답 오류",e.status)}catch(t){n.log("error","❌ TikTok 영상 분석 실패",t.message)}}setupMessageListeners(){chrome.runtime.onMessage.addListener((t,e,n)=>(this.handleMessage(t,e,n),!0))}async handleMessage(e,o,i){try{switch(e.action){case"ping":i({success:!0,message:"Complete Content Script 응답"});break;case"getStatus":i({success:!0,data:{platform:this.platform,serverUrl:t.SERVER_URL,environment:t.NODE_ENV,features:{instagramMediaTracker:!!window.INSTAGRAM_MEDIA_TRACKER,youtubeChannelAnalyzer:!!window.youtubeChannelAnalyzer,instagramUISystem:!!window.INSTAGRAM_UI_SYSTEM},version:"complete-restored"}});break;default:i({error:"알 수 없는 액션입니다."})}}catch(t){n.log("error","메시지 처리 실패",t.message),i({error:t.message})}}cleanup(){window.INSTAGRAM_UI_SYSTEM&&a.cleanup(),n.log("info","Complete Content Script 정리 완료")}}try{n.log("info","🚀 InsightReel Complete Content Script 초기화 시작");const o=new r;window.INSIGHTREEL={contentScript:o,utils:n,platforms:e,environment:t,version:"complete-restored"},t.isDevelopment&&(window.ContentScript=o,window.Utils=n,window.PLATFORMS=e,window.environment=t,n.log("info","🛠️ 개발 모드: 디버깅 객체들이 window에 등록됨")),n.log("success","✅ InsightReel Complete Content Script 초기화 완료")}catch(t){console.error("❌ InsightReel Complete Content Script 실행 오류:",t),console.error("오류 위치:",t.stack),window.INSIGHTREEL_ERROR={error:t.message,stack:t.stack,timestamp:(new Date).toISOString(),version:"complete-restored"}}})();