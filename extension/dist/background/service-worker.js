new class{constructor(){this.serverUrl=this.getServerUrl(),this.init()}getServerUrl(){return chrome.runtime.getManifest().version.includes("dev")||chrome.runtime.getManifest().name.includes("개발")?"http://localhost:3000":"https://api.yourdomain.com"}init(){chrome.runtime.onInstalled.addListener(e=>{console.log("Service Worker 시작, 이유:",e.reason),"install"===e.reason?(console.log("⚡ 실제 설치: 기본 설정 초기화"),this.handleInstall()):"update"===e.reason?(console.log("⚡ 업데이트: 설정 유지"),this.handleUpdate(e.previousVersion)):console.log("⚡ 재시작: 설정 그대로 유지")}),chrome.runtime.onMessage.addListener((e,t,s)=>(this.handleMessage(e,t,s),!0)),this.createContextMenus(),this.schedulePeriodicTasks()}handleInstall(){console.log("InsightReel이 설치되었습니다."),chrome.storage.sync.set({videosaverSettings:{autoAnalysis:!1,autoSave:!0,showNotifications:!0},serverUrl:this.serverUrl})}handleUpdate(e){console.log(`확장프로그램이 ${e}에서 업데이트되었습니다.`)}async handleMessage(e,t,s){try{switch(e.action){case"downloadVideo":await this.downloadVideo(e.data,s);break;case"testServer":await this.testServerConnection(s);break;case"getSettings":await this.getSettings(s);break;case"saveSettings":await this.saveSettings(e.data,s);break;case"syncInstagramCookies":await this.syncInstagramCookies(s);break;default:s({error:"알 수 없는 액션입니다."})}}catch(e){console.error("메시지 처리 실패:",e),s({error:e.message})}}createContextMenus(){chrome.contextMenus.create({id:"saveVideo",title:"이 영상 저장 및 분석",contexts:["video"],documentUrlPatterns:["https://www.instagram.com/*","https://www.tiktok.com/*"]}),chrome.contextMenus.create({id:"openSpreadsheet",title:"분석 결과 스프레드시트 열기",contexts:["page"],documentUrlPatterns:["https://www.instagram.com/*","https://www.tiktok.com/*"]}),chrome.contextMenus.onClicked.addListener((e,t)=>{this.handleContextMenuClick(e,t)})}async handleContextMenuClick(e,t){switch(e.menuItemId){case"saveVideo":chrome.tabs.sendMessage(t.id,{action:"saveCurrentVideo",url:e.srcUrl});break;case"openSpreadsheet":const s=await this.getStoredSettings();s.spreadsheetUrl?chrome.tabs.create({url:s.spreadsheetUrl}):this.showNotification("스프레드시트가 아직 생성되지 않았습니다.")}}async downloadVideo(e,t){try{const s=await fetch(`${this.serverUrl}/api/process-video`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)}),o=await s.json();s.ok&&(this.showNotification(`✅ 영상이 저장되었습니다!\n카테고리: ${o.mainCategory}`),o.spreadsheetUrl&&chrome.storage.sync.set({spreadsheetUrl:o.spreadsheetUrl})),t(o)}catch(e){t({error:e.message})}}async testServerConnection(e){try{const t=await fetch(`${this.serverUrl}/health`,{method:"GET",timeout:5e3});e({connected:t.ok,status:t.status,timestamp:(new Date).toISOString()})}catch(t){e({connected:!1,error:t.message,suggestion:"로컬 서버가 실행 중인지 확인해주세요."})}}async getSettings(e){try{e(await this.getStoredSettings())}catch(t){e({error:t.message})}}async saveSettings(e,t){try{await chrome.storage.sync.set(e),t({success:!0})}catch(e){t({error:e.message})}}getStoredSettings(){return new Promise(e=>{chrome.storage.sync.get(["videosaverSettings","serverUrl","spreadsheetUrl"],t=>{const s=t.videosaverSettings||{};e({...s,serverUrl:t.serverUrl,spreadsheetUrl:t.spreadsheetUrl})})})}showNotification(e,t="basic"){chrome.storage.sync.get(["videosaverSettings"],s=>{!1!==(s.videosaverSettings||{}).showNotifications&&chrome.notifications.create({type:t,iconUrl:"icons/icon48.png",title:"InsightReel",message:e})})}schedulePeriodicTasks(){setInterval(async()=>{try{await fetch(`${this.serverUrl}/health`),chrome.storage.local.set({lastServerCheck:Date.now()})}catch(e){console.log("서버 연결 확인 실패:",e)}},36e5),setInterval(()=>{this.checkDataCleanup()},864e5)}async checkDataCleanup(){try{(await fetch(`${this.serverUrl}/api/cleanup-old-files`,{method:"POST"})).ok&&console.log("오래된 파일 정리 완료")}catch(e){console.log("파일 정리 확인 실패:",e)}}async syncInstagramCookies(e){try{console.log("🍪 Instagram 쿠키 동기화 시작");const t=[{domain:".instagram.com"},{domain:"instagram.com"},{domain:"www.instagram.com"},{url:"https://www.instagram.com/"},{url:"https://instagram.com/"},{url:"https://www.instagram.com"},{storeId:"0",url:"https://www.instagram.com/"}];let s=[];for(const e of t)try{const t=await chrome.cookies.getAll(e);console.log(`🍪 ${JSON.stringify(e)} 패턴으로 ${t.length}개 쿠키 발견`),s=s.concat(t)}catch(t){console.log(`🍪 패턴 ${JSON.stringify(e)} 실패:`,t)}const o=s.filter((e,t,s)=>t===s.findIndex(t=>t.name===e.name&&t.domain===e.domain));if(console.log(`🍪 총 ${o.length}개 고유 쿠키 발견`),0===o.length)return void e({success:!1,error:"Instagram에 로그인 상태가 아니거나 쿠키를 찾을 수 없습니다."});const a="# Netscape HTTP Cookie File\n# This file is generated by InsightReel Extension.\n\n"+o.map(e=>{const t=e.domain.startsWith(".")?e.domain:`.${e.domain}`,s=e.secure?"TRUE":"FALSE",o=(e.httpOnly,Math.floor(e.expirationDate||Date.now()/1e3+604800));return`${t}\tTRUE\t${e.path}\t${s}\t${o}\t${e.name}\t${e.value}`}).join("\n");console.log(`🍪 Netscape 형식 변환 완료 (${a.length} 문자)`);const r=await fetch(`${this.serverUrl}/api/system/update-cookies`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({cookies:a,source:"chrome-extension",timestamp:(new Date).toISOString()})}),n=await r.json();if(!r.ok)throw new Error(n.error||"서버 응답 오류");console.log("✅ 쿠키 동기화 성공"),this.showNotification("Instagram 쿠키가 성공적으로 동기화되었습니다!"),e({success:!0,message:"쿠키 동기화 완료",cookieCount:o.length})}catch(t){console.error("❌ 쿠키 동기화 실패:",t),e({success:!1,error:t.message||"알 수 없는 오류 발생"})}}modifyWebRequests(){chrome.webRequest.onBeforeSendHeaders.addListener(e=>({requestHeaders:e.requestHeaders}),{urls:["https://www.instagram.com/*","https://www.tiktok.com/*"]},["blocking","requestHeaders"])}};