new class{constructor(){this.serverUrl=this.getServerUrl(),this.init()}getServerUrl(){return chrome.runtime.getManifest().version.includes("dev")||chrome.runtime.getManifest().name.includes("ê°œë°œ")?"http://localhost:3000":"https://api.yourdomain.com"}init(){chrome.runtime.onInstalled.addListener(e=>{console.log("Service Worker ì‹œìž‘, ì´ìœ :",e.reason),"install"===e.reason?(console.log("âš¡ ì‹¤ì œ ì„¤ì¹˜: ê¸°ë³¸ ì„¤ì • ì´ˆê¸°í™”"),this.handleInstall()):"update"===e.reason?(console.log("âš¡ ì—…ë°ì´íŠ¸: ì„¤ì • ìœ ì§€"),this.handleUpdate(e.previousVersion)):console.log("âš¡ ìž¬ì‹œìž‘: ì„¤ì • ê·¸ëŒ€ë¡œ ìœ ì§€")}),chrome.runtime.onMessage.addListener((e,t,s)=>(this.handleMessage(e,t,s),!0)),this.createContextMenus(),this.schedulePeriodicTasks()}handleInstall(){console.log("InsightReelì´ ì„¤ì¹˜ë˜ì—ˆìŠµë‹ˆë‹¤."),chrome.storage.sync.set({videosaverSettings:{autoAnalysis:!1,autoSave:!0,showNotifications:!0},serverUrl:this.serverUrl})}handleUpdate(e){console.log(`í™•ìž¥í”„ë¡œê·¸ëž¨ì´ ${e}ì—ì„œ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.`)}async handleMessage(e,t,s){try{switch(e.action){case"downloadVideo":await this.downloadVideo(e.data,s);break;case"testServer":await this.testServerConnection(s);break;case"getSettings":await this.getSettings(s);break;case"saveSettings":await this.saveSettings(e.data,s);break;case"syncInstagramCookies":await this.syncInstagramCookies(s);break;default:s({error:"ì•Œ ìˆ˜ ì—†ëŠ” ì•¡ì…˜ìž…ë‹ˆë‹¤."})}}catch(e){console.error("ë©”ì‹œì§€ ì²˜ë¦¬ ì‹¤íŒ¨:",e),s({error:e.message})}}createContextMenus(){chrome.contextMenus.create({id:"saveVideo",title:"ì´ ì˜ìƒ ì €ìž¥ ë° ë¶„ì„",contexts:["video"],documentUrlPatterns:["https://www.instagram.com/*","https://www.tiktok.com/*"]}),chrome.contextMenus.create({id:"openSpreadsheet",title:"ë¶„ì„ ê²°ê³¼ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ì—´ê¸°",contexts:["page"],documentUrlPatterns:["https://www.instagram.com/*","https://www.tiktok.com/*"]}),chrome.contextMenus.onClicked.addListener((e,t)=>{this.handleContextMenuClick(e,t)})}async handleContextMenuClick(e,t){switch(e.menuItemId){case"saveVideo":chrome.tabs.sendMessage(t.id,{action:"saveCurrentVideo",url:e.srcUrl});break;case"openSpreadsheet":const s=await this.getStoredSettings();s.spreadsheetUrl?chrome.tabs.create({url:s.spreadsheetUrl}):this.showNotification("ìŠ¤í”„ë ˆë“œì‹œíŠ¸ê°€ ì•„ì§ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")}}async downloadVideo(e,t){try{const s=await fetch(`${this.serverUrl}/api/process-video`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)}),o=await s.json();s.ok&&(this.showNotification(`âœ… ì˜ìƒì´ ì €ìž¥ë˜ì—ˆìŠµë‹ˆë‹¤!\nì¹´í…Œê³ ë¦¬: ${o.mainCategory}`),o.spreadsheetUrl&&chrome.storage.sync.set({spreadsheetUrl:o.spreadsheetUrl})),t(o)}catch(e){t({error:e.message})}}async testServerConnection(e){try{const t=await fetch(`${this.serverUrl}/health`,{method:"GET",timeout:5e3});e({connected:t.ok,status:t.status,timestamp:(new Date).toISOString()})}catch(t){e({connected:!1,error:t.message,suggestion:"ë¡œì»¬ ì„œë²„ê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸í•´ì£¼ì„¸ìš”."})}}async getSettings(e){try{e(await this.getStoredSettings())}catch(t){e({error:t.message})}}async saveSettings(e,t){try{await chrome.storage.sync.set(e),t({success:!0})}catch(e){t({error:e.message})}}getStoredSettings(){return new Promise(e=>{chrome.storage.sync.get(["videosaverSettings","serverUrl","spreadsheetUrl"],t=>{const s=t.videosaverSettings||{};e({...s,serverUrl:t.serverUrl,spreadsheetUrl:t.spreadsheetUrl})})})}showNotification(e,t="basic"){chrome.storage.sync.get(["videosaverSettings"],s=>{!1!==(s.videosaverSettings||{}).showNotifications&&chrome.notifications.create({type:t,iconUrl:"icons/icon48.png",title:"InsightReel",message:e})})}schedulePeriodicTasks(){setInterval(async()=>{try{await fetch(`${this.serverUrl}/health`),chrome.storage.local.set({lastServerCheck:Date.now()})}catch(e){console.log("ì„œë²„ ì—°ê²° í™•ì¸ ì‹¤íŒ¨:",e)}},36e5),setInterval(()=>{this.checkDataCleanup()},864e5)}async checkDataCleanup(){try{(await fetch(`${this.serverUrl}/api/cleanup-old-files`,{method:"POST"})).ok&&console.log("ì˜¤ëž˜ëœ íŒŒì¼ ì •ë¦¬ ì™„ë£Œ")}catch(e){console.log("íŒŒì¼ ì •ë¦¬ í™•ì¸ ì‹¤íŒ¨:",e)}}async syncInstagramCookies(e){try{console.log("ðŸª Instagram ì¿ í‚¤ ë™ê¸°í™” ì‹œìž‘");const t=[{domain:".instagram.com"},{domain:"instagram.com"},{domain:"www.instagram.com"},{url:"https://www.instagram.com/"},{url:"https://instagram.com/"},{url:"https://www.instagram.com"},{storeId:"0",url:"https://www.instagram.com/"}];let s=[];for(const e of t)try{const t=await chrome.cookies.getAll(e);console.log(`ðŸª ${JSON.stringify(e)} íŒ¨í„´ìœ¼ë¡œ ${t.length}ê°œ ì¿ í‚¤ ë°œê²¬`),s=s.concat(t)}catch(t){console.log(`ðŸª íŒ¨í„´ ${JSON.stringify(e)} ì‹¤íŒ¨:`,t)}const o=s.filter((e,t,s)=>t===s.findIndex(t=>t.name===e.name&&t.domain===e.domain));if(console.log(`ðŸª ì´ ${o.length}ê°œ ê³ ìœ  ì¿ í‚¤ ë°œê²¬`),0===o.length)return void e({success:!1,error:"Instagramì— ë¡œê·¸ì¸ ìƒíƒœê°€ ì•„ë‹ˆê±°ë‚˜ ì¿ í‚¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."});const a="# Netscape HTTP Cookie File\n# This file is generated by InsightReel Extension.\n\n"+o.map(e=>{const t=e.domain.startsWith(".")?e.domain:`.${e.domain}`,s=e.secure?"TRUE":"FALSE",o=(e.httpOnly,Math.floor(e.expirationDate||Date.now()/1e3+604800));return`${t}\tTRUE\t${e.path}\t${s}\t${o}\t${e.name}\t${e.value}`}).join("\n");console.log(`ðŸª Netscape í˜•ì‹ ë³€í™˜ ì™„ë£Œ (${a.length} ë¬¸ìž)`);const r=await fetch(`${this.serverUrl}/api/system/update-cookies`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({cookies:a,source:"chrome-extension",timestamp:(new Date).toISOString()})}),n=await r.json();if(!r.ok)throw new Error(n.error||"ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜");console.log("âœ… ì¿ í‚¤ ë™ê¸°í™” ì„±ê³µ"),this.showNotification("Instagram ì¿ í‚¤ê°€ ì„±ê³µì ìœ¼ë¡œ ë™ê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤!"),e({success:!0,message:"ì¿ í‚¤ ë™ê¸°í™” ì™„ë£Œ",cookieCount:o.length})}catch(t){console.error("âŒ ì¿ í‚¤ ë™ê¸°í™” ì‹¤íŒ¨:",t),e({success:!1,error:t.message||"ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ ë°œìƒ"})}}modifyWebRequests(){chrome.webRequest.onBeforeSendHeaders.addListener(e=>({requestHeaders:e.requestHeaders}),{urls:["https://www.instagram.com/*","https://www.tiktok.com/*"]},["blocking","requestHeaders"])}};