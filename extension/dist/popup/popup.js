(()=>{class e{constructor(){this.serverUrl="http://localhost:3000",this.init()}async init(){console.log("🚀 팝업 초기화 시작"),"loading"===document.readyState&&await new Promise(e=>document.addEventListener("DOMContentLoaded",e));const e=document.getElementById("syncInstagramCookies");console.log("🍪 Instagram 쿠키 버튼 찾음:",!!e),await this.loadSettings(),this.setupEventListeners(),await Promise.all([this.checkServerStatus(),this.loadStats()]),console.log("📋 팝업 초기화 완료")}async checkServerStatus(){const e=document.getElementById("status"),t=document.getElementById("statusText");try{if(!(await fetch(`${this.serverUrl}/health`)).ok)throw new Error("서버 응답 오류");e.className="status connected",t.textContent="✅ 서버 연결됨"}catch(n){e.className="status error",t.textContent="❌ 서버 연결 안됨 (로컬 서버를 시작해주세요)"}}async loadStats(){try{const e=await fetch(`${this.serverUrl}/api/stats`);if(e.ok){const t=await e.json();document.getElementById("totalVideos").textContent=t.total||0,document.getElementById("todayVideos").textContent=t.today||0}}catch(e){console.log("통계 로드 실패:",e)}}setupEventListeners(){this.debounceTimers={};const e=document.getElementById("syncInstagramCookies");console.log("🔍 Instagram 쿠키 버튼 찾기:",!!e),e?(e.addEventListener("click",async()=>{console.log("🍪 Instagram 쿠키 동기화 버튼 클릭됨");const e=document.getElementById("syncInstagramCookies"),t=e.textContent;try{console.log("🚀 서비스 워커로 쿠키 동기화 요청"),e.disabled=!0,e.textContent="⏳ 쿠키 처리 중...";const n=await chrome.runtime.sendMessage({action:"syncInstagramCookies"});if(console.log("📬 서비스 워커 응답:",n),!n.success)throw new Error(n.error||"알 수 없는 오류");console.log("✅ 쿠키 동기화 성공"),e.textContent="✅ 동기화 완료!",e.style.background="linear-gradient(135deg, #4CAF50 0%, #45a049 100%)",n.cookieCount&&(e.textContent=`✅ 완료 (${n.cookieCount}개 쿠키)`),setTimeout(()=>{e.textContent=t,e.style.background="linear-gradient(135deg, #667eea 0%, #764ba2 100%)"},5e3)}catch(n){console.error("❌ 쿠키 동기화 실패:",n),e.textContent="❌ 동기화 실패",e.style.background="linear-gradient(135deg, #f44336 0%, #d32f2f 100%)",setTimeout(()=>{e.textContent=t,e.style.background="linear-gradient(135deg, #667eea 0%, #764ba2 100%)"},3e3)}finally{e.disabled=!1}}),document.getElementById("openSheets").addEventListener("click",async()=>{try{const e=await fetch(`${this.serverUrl}/api/test-sheets`);if(e.ok){const t=await e.json();if(t.result&&t.result.spreadsheetUrl)return void chrome.tabs.create({url:t.result.spreadsheetUrl})}}catch(e){console.log("서버에서 스프레드시트 정보 가져오기 실패:",e)}chrome.storage.sync.get(["spreadsheetUrl"],e=>{if(e.spreadsheetUrl)chrome.tabs.create({url:e.spreadsheetUrl});else{const e="https://docs.google.com/spreadsheets/d/1UkGu6HObPNo6cPojBzhYeFxNVMkTksrsANTuSGKloJA";chrome.tabs.create({url:e})}})}),document.getElementById("testConnection").addEventListener("click",async()=>{await this.testConnection()}),document.getElementById("collectChannel").addEventListener("click",async()=>{await this.collectChannel()}),["useAI","autoAnalyze","autoSave","batchMode","showNotifications"].forEach(e=>{document.getElementById(e).addEventListener("change",t=>{this.debounceTimers[e]&&clearTimeout(this.debounceTimers[e]);const n=t.target;n.style.transform="scale(1.1)",n.style.transition="transform 0.15s ease",setTimeout(()=>{n.style.transform="scale(1)"},150),console.log(`${e} 토글: ${t.target.checked}`),this.debounceTimers[e]=setTimeout(()=>{this.saveSetting(e,t.target.checked)},200)})})):console.error("❌ Instagram 쿠키 버튼을 찾을 수 없습니다")}async testConnection(){const e=document.getElementById("testConnection"),t=e.textContent;e.textContent="테스트 중...",e.disabled=!0;try{const e=await fetch(`${this.serverUrl}/health`),t=await fetch(`${this.serverUrl}/api/test-sheets`);let n="연결 테스트 결과:\n";n+=`서버: ${e.ok?"✅":"❌"}\n`,n+="구글 시트: "+(t.ok?"✅":"❌"),this.showNotification(n)}catch(e){this.showNotification("연결 테스트 실패: "+e.message)}finally{e.textContent=t,e.disabled=!1}}async collectChannel(){const e=document.getElementById("collectChannel"),t=e.textContent;try{const[t]=await chrome.tabs.query({active:!0,currentWindow:!0});if(!(t.url.includes("/channel/")||t.url.includes("/@")||t.url.includes("/c/")||t.url.includes("/user/")))return void this.showNotification("❌ YouTube 채널 페이지에서만 사용할 수 있습니다.");e.textContent="수집 중...",e.disabled=!0;const n=await chrome.tabs.sendMessage(t.id,{action:"showChannelCollectModal"});if(!n||!n.success)throw new Error((null==n?void 0:n.error)||"채널 수집 기능을 찾을 수 없습니다.");window.close()}catch(n){console.error("채널 수집 실패:",n),this.showNotification("❌ 채널 수집 실패: "+n.message),e.textContent="실패",e.style.background="#f44336",setTimeout(()=>{e.textContent=t,e.style.background="linear-gradient(45deg, #ff6b6b, #ee5a24)",e.disabled=!1},2e3)}}async loadSettings(){try{const e=(await new Promise(e=>{chrome.storage.sync.get(["videosaverSettings"],e)})).videosaverSettings||{};console.log("📋 로드된 설정:",e);const t=document.getElementById("useAI"),n=document.getElementById("autoAnalyze"),o=document.getElementById("autoSave"),s=document.getElementById("batchMode"),a=document.getElementById("showNotifications");if(!(t&&n&&o&&s&&a))return void console.warn("⚠️ DOM 요소가 아직 준비되지 않음");t.checked=void 0===e.useAI||e.useAI,n.checked=void 0!==e.autoAnalysis&&e.autoAnalysis,o.checked=void 0===e.autoSave||e.autoSave,s.checked=void 0!==e.batchMode&&e.batchMode,a.checked=void 0===e.showNotifications||e.showNotifications;const c=document.getElementById("settingsContainer");c&&(c.style.opacity="1"),console.log("✅ UI 반영 완료")}catch(e){console.error("❌ 설정 로드 실패:",e);const t=document.getElementById("settingsContainer");t&&(t.style.opacity="1")}}async saveSetting(e,t){try{console.log(`💾 설정 저장 시작: ${e} = ${t}`);const n=(await new Promise(e=>{chrome.storage.sync.get(["videosaverSettings"],e)})).videosaverSettings||{};console.log("📋 현재 저장된 설정:",n);let o=e;"autoAnalyze"===e&&(o="autoAnalysis");const s={...n,[o]:t};console.log("🔄 업데이트될 설정:",s),await new Promise(e=>{chrome.storage.sync.set({videosaverSettings:s},e)}),console.log(`✅ 설정 저장 완료: ${o} = ${t}`),this.showQuickFeedback(o)}catch(e){console.error("❌ 설정 저장 실패:",e),this.showNotification("❌ 설정 저장에 실패했습니다")}}showQuickFeedback(e){let t=e;"autoAnalysis"===e&&(t="autoAnalyze");const n=document.getElementById(t);if(n&&n.parentElement){const e=document.createElement("span");if(e.textContent="✓",e.style.cssText="\n        color: #4caf50;\n        font-weight: bold;\n        margin-left: 5px;\n        animation: fadeOut 1s ease-out forwards;\n      ",!document.getElementById("feedback-animation")){const e=document.createElement("style");e.id="feedback-animation",e.textContent="\n          @keyframes fadeOut {\n            0% { opacity: 1; }\n            100% { opacity: 0; }\n          }\n        ",document.head.appendChild(e)}n.parentElement.appendChild(e),setTimeout(()=>{e.parentElement&&e.parentElement.removeChild(e)},1e3)}}showNotification(e){const t=document.createElement("div");t.style.cssText="\n      position: fixed;\n      top: 10px;\n      left: 10px;\n      right: 10px;\n      background: #333;\n      color: white;\n      padding: 10px;\n      border-radius: 5px;\n      z-index: 1000;\n      font-size: 12px;\n      white-space: pre-line;\n    ",t.textContent=e,document.body.appendChild(t),setTimeout(()=>{document.body.removeChild(t)},3e3)}}document.addEventListener("DOMContentLoaded",()=>{new e})})();