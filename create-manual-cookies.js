const fs = require('fs');
const path = require('path');

/**
 * 수동 Instagram 쿠키 생성 도구
 * Chrome에서 복사한 쿠키를 Netscape 형식으로 변환
 */

function createManualCookies() {
    console.log('🍪 수동 Instagram 쿠키 생성 도구');
    console.log('=' * 50);

    console.log('\n📋 단계별 안내:');
    console.log('1. Chrome에서 Instagram.com에 로그인');
    console.log('2. F12 → Application → Storage → Cookies → https://instagram.com');
    console.log('3. 아래 쿠키들의 Value를 복사하세요:');

    const requiredCookies = [
        { name: 'sessionid', description: '로그인 세션 (가장 중요)' },
        { name: 'csrftoken', description: 'CSRF 보호 토큰' },
        { name: 'mid', description: '머신 ID' },
        { name: 'ig_did', description: '디바이스 ID' }
    ];

    console.log('\n🔑 필요한 쿠키들:');
    requiredCookies.forEach(cookie => {
        console.log(`   - ${cookie.name}: ${cookie.description}`);
    });

    console.log('\n💡 이 스크립트를 실행한 후 쿠키 값을 입력하세요.');
    console.log('   node create-manual-cookies.js');

    // 사용자 입력 대기 (실제로는 readline 사용해야 함)
    const readline = require('readline');
    const rl = readline.createInterface({
        input: process.stdin,
        output: process.stdout
    });

    const cookies = {};

    function askForCookie(index = 0) {
        if (index >= requiredCookies.length) {
            generateCookieFile(cookies);
            rl.close();
            return;
        }

        const cookie = requiredCookies[index];
        rl.question(`\n${cookie.name} 값을 입력하세요 (${cookie.description}): `, (answer) => {
            if (answer.trim()) {
                cookies[cookie.name] = answer.trim();
                console.log(`✅ ${cookie.name} 저장됨`);
            } else {
                console.log(`⚠️ ${cookie.name} 건너뜀`);
            }
            askForCookie(index + 1);
        });
    }

    function generateCookieFile(cookies) {
        const cookiesPath = path.join(__dirname, 'data/instagram_cookies.txt');

        // Netscape 형식으로 쿠키 파일 생성
        const lines = [
            '# Netscape HTTP Cookie File',
            '# Generated by Manual Cookie Creator',
            `# Created: ${new Date().toISOString()}`
        ];

        const expireTime = Math.floor(Date.now() / 1000) + (30 * 24 * 60 * 60); // 30일 후

        Object.entries(cookies).forEach(([name, value]) => {
            if (value) {
                const line = `.instagram.com\tTRUE\t/\tTRUE\t${expireTime}\t${name}\t${value}`;
                lines.push(line);
            }
        });

        try {
            fs.writeFileSync(cookiesPath, lines.join('\n'));

            console.log('\n🎉 쿠키 파일 생성 성공!');
            console.log(`📍 위치: ${cookiesPath}`);
            console.log(`📊 생성된 쿠키 수: ${Object.keys(cookies).length}개`);

            if (cookies.sessionid) {
                console.log('\n✅ sessionid가 포함되어 있어 로그인 상태가 유지됩니다.');
                console.log('🚀 이제 Instagram 비디오 다운로드가 가능합니다!');
            } else {
                console.log('\n⚠️ sessionid가 없어 로그인이 필요할 수 있습니다.');
            }

            console.log('\n🧪 테스트 방법:');
            console.log('   node test-processVideo-instagram.js');

        } catch (error) {
            console.error('\n❌ 쿠키 파일 생성 실패:', error.message);
        }
    }

    console.log('\n시작하려면 Enter를 누르세요...');
    rl.question('', () => {
        askForCookie();
    });
}

// 직접 실행 시
if (require.main === module) {
    createManualCookies();
}

module.exports = { createManualCookies };