const fs = require('fs');
const path = require('path');

/**
 * ìˆ˜ë™ Instagram ì¿ í‚¤ ìƒì„± ë„êµ¬
 * Chromeì—ì„œ ë³µì‚¬í•œ ì¿ í‚¤ë¥¼ Netscape í˜•ì‹ìœ¼ë¡œ ë³€í™˜
 */

function createManualCookies() {
    console.log('ğŸª ìˆ˜ë™ Instagram ì¿ í‚¤ ìƒì„± ë„êµ¬');
    console.log('=' * 50);

    console.log('\nğŸ“‹ ë‹¨ê³„ë³„ ì•ˆë‚´:');
    console.log('1. Chromeì—ì„œ Instagram.comì— ë¡œê·¸ì¸');
    console.log('2. F12 â†’ Application â†’ Storage â†’ Cookies â†’ https://instagram.com');
    console.log('3. ì•„ë˜ ì¿ í‚¤ë“¤ì˜ Valueë¥¼ ë³µì‚¬í•˜ì„¸ìš”:');

    const requiredCookies = [
        { name: 'sessionid', description: 'ë¡œê·¸ì¸ ì„¸ì…˜ (ê°€ì¥ ì¤‘ìš”)' },
        { name: 'csrftoken', description: 'CSRF ë³´í˜¸ í† í°' },
        { name: 'mid', description: 'ë¨¸ì‹  ID' },
        { name: 'ig_did', description: 'ë””ë°”ì´ìŠ¤ ID' }
    ];

    console.log('\nğŸ”‘ í•„ìš”í•œ ì¿ í‚¤ë“¤:');
    requiredCookies.forEach(cookie => {
        console.log(`   - ${cookie.name}: ${cookie.description}`);
    });

    console.log('\nğŸ’¡ ì´ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‹¤í–‰í•œ í›„ ì¿ í‚¤ ê°’ì„ ì…ë ¥í•˜ì„¸ìš”.');
    console.log('   node create-manual-cookies.js');

    // ì‚¬ìš©ì ì…ë ¥ ëŒ€ê¸° (ì‹¤ì œë¡œëŠ” readline ì‚¬ìš©í•´ì•¼ í•¨)
    const readline = require('readline');
    const rl = readline.createInterface({
        input: process.stdin,
        output: process.stdout
    });

    const cookies = {};

    function askForCookie(index = 0) {
        if (index >= requiredCookies.length) {
            generateCookieFile(cookies);
            rl.close();
            return;
        }

        const cookie = requiredCookies[index];
        rl.question(`\n${cookie.name} ê°’ì„ ì…ë ¥í•˜ì„¸ìš” (${cookie.description}): `, (answer) => {
            if (answer.trim()) {
                cookies[cookie.name] = answer.trim();
                console.log(`âœ… ${cookie.name} ì €ì¥ë¨`);
            } else {
                console.log(`âš ï¸ ${cookie.name} ê±´ë„ˆëœ€`);
            }
            askForCookie(index + 1);
        });
    }

    function generateCookieFile(cookies) {
        const cookiesPath = path.join(__dirname, 'data/instagram_cookies.txt');

        // Netscape í˜•ì‹ìœ¼ë¡œ ì¿ í‚¤ íŒŒì¼ ìƒì„±
        const lines = [
            '# Netscape HTTP Cookie File',
            '# Generated by Manual Cookie Creator',
            `# Created: ${new Date().toISOString()}`
        ];

        const expireTime = Math.floor(Date.now() / 1000) + (30 * 24 * 60 * 60); // 30ì¼ í›„

        Object.entries(cookies).forEach(([name, value]) => {
            if (value) {
                const line = `.instagram.com\tTRUE\t/\tTRUE\t${expireTime}\t${name}\t${value}`;
                lines.push(line);
            }
        });

        try {
            fs.writeFileSync(cookiesPath, lines.join('\n'));

            console.log('\nğŸ‰ ì¿ í‚¤ íŒŒì¼ ìƒì„± ì„±ê³µ!');
            console.log(`ğŸ“ ìœ„ì¹˜: ${cookiesPath}`);
            console.log(`ğŸ“Š ìƒì„±ëœ ì¿ í‚¤ ìˆ˜: ${Object.keys(cookies).length}ê°œ`);

            if (cookies.sessionid) {
                console.log('\nâœ… sessionidê°€ í¬í•¨ë˜ì–´ ìˆì–´ ë¡œê·¸ì¸ ìƒíƒœê°€ ìœ ì§€ë©ë‹ˆë‹¤.');
                console.log('ğŸš€ ì´ì œ Instagram ë¹„ë””ì˜¤ ë‹¤ìš´ë¡œë“œê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤!');
            } else {
                console.log('\nâš ï¸ sessionidê°€ ì—†ì–´ ë¡œê·¸ì¸ì´ í•„ìš”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
            }

            console.log('\nğŸ§ª í…ŒìŠ¤íŠ¸ ë°©ë²•:');
            console.log('   node test-processVideo-instagram.js');

        } catch (error) {
            console.error('\nâŒ ì¿ í‚¤ íŒŒì¼ ìƒì„± ì‹¤íŒ¨:', error.message);
        }
    }

    console.log('\nì‹œì‘í•˜ë ¤ë©´ Enterë¥¼ ëˆ„ë¥´ì„¸ìš”...');
    rl.question('', () => {
        askForCookie();
    });
}

// ì§ì ‘ ì‹¤í–‰ ì‹œ
if (require.main === module) {
    createManualCookies();
}

module.exports = { createManualCookies };