/**
 * StatCard - ÎèôÏ†Å ÌÜµÍ≥Ñ Ïπ¥Îìú Ïª¥Ìè¨ÎÑåÌä∏
 * ÌïòÎìúÏΩîÎî©Îêú ÌÜµÍ≥Ñ Ïπ¥ÎìúÎ•º ÏôÑÏ†Ñ ÎèôÏ†ÅÏúºÎ°ú ÏÉùÏÑ± Î∞è Í¥ÄÎ¶¨
 */

class StatCard {
  constructor(config, container) {
    this.id = config.id;
    this.value = config.value || 0;
    this.label = config.label || '';
    this.icon = config.icon || 'üìä';
    this.color = config.color || 'primary';
    this.clickable = config.clickable || false;
    this.onClick = config.onclick || null;
    this.container = typeof container === 'string' ? document.querySelector(container) : container;
    this.animationEnabled = config.animationEnabled !== false;
    this.formatValue = config.formatValue || this.defaultFormatValue;
    
    // ÏÉÅÌÉú Í¥ÄÎ¶¨
    this.isLoading = false;
    this.lastValue = this.value;
    this.updateCount = 0;
    
    // ÏÑ§Ï†ï Í≤ÄÏ¶ù
    this.validateConfig();
    
    // Ï¥àÍ∏∞ Î†åÎçîÎßÅ
    this.render();
    this.bindEvents();
    
    // ÎîîÎ≤ÑÍ∑∏ Î°úÍ∑∏
    console.log('üìä StatCard Ï¥àÍ∏∞Ìôî ÏôÑÎ£å:', {
      id: this.id,
      label: this.label,
      value: this.value,
      clickable: this.clickable
    });
  }
  
  /**
   * ÏÑ§Ï†ï Í≤ÄÏ¶ù
   */
  validateConfig() {
    if (!this.id) {
      throw new Error('StatCard: idÍ∞Ä ÌïÑÏöîÌï©ÎãàÎã§');
    }
    
    if (!this.label) {
      throw new Error('StatCard: labelÏù¥ ÌïÑÏöîÌï©ÎãàÎã§');
    }
    
    // ÏÉâÏÉÅ Í≤ÄÏ¶ù
    const validColors = ['primary', 'secondary', 'success', 'error', 'warning', 'info'];
    if (!validColors.includes(this.color)) {
      console.warn(`‚ö†Ô∏è StatCard: ÏßÄÏõêÌïòÏßÄ ÏïäÎäî ÏÉâÏÉÅ '${this.color}', 'primary'Î°ú ÎåÄÏ≤¥`);
      this.color = 'primary';
    }
  }
  
  /**
   * Í∏∞Î≥∏ Í∞í Ìè¨Îß∑ÌåÖ
   */
  defaultFormatValue(value) {
    if (typeof value === 'number') {
      if (value >= 1000000) {
        return (value / 1000000).toFixed(1) + 'M';
      } else if (value >= 1000) {
        return (value / 1000).toFixed(1) + 'K';
      }
      return value.toLocaleString();
    }
    return String(value);
  }
  
  /**
   * Ïπ¥Îìú HTML ÏÉùÏÑ±
   */
  generateHTML() {
    const formattedValue = this.formatValue(this.value);
    const clickableClass = this.clickable ? 'clickable' : '';
    const colorClass = `stat-card-${this.color}`;
    const loadingClass = this.isLoading ? 'loading' : '';
    
    return `
      <div 
        class="stat-card ${clickableClass} ${colorClass} ${loadingClass}" 
        data-stat-id="${this.id}"
        data-color="${this.color}"
        role="${this.clickable ? 'button' : 'status'}"
        tabindex="${this.clickable ? '0' : '-1'}"
        aria-label="${this.label}: ${formattedValue}"
        title="${this.clickable ? 'ÌÅ¥Î¶≠ÌïòÏó¨ ÏÉÅÏÑ∏Î≥¥Í∏∞' : this.label}"
      >
        ${this.isLoading ? '<div class="stat-loader"></div>' : ''}
        <div class="stat-icon" aria-hidden="true">${this.icon}</div>
        <div class="stat-number" data-value="${this.value}">${formattedValue}</div>
        <div class="stat-label">${this.label}</div>
        ${this.clickable ? '<div class="stat-click-hint" aria-hidden="true">ÌÅ¥Î¶≠</div>' : ''}
      </div>
    `;
  }
  
  /**
   * Ïπ¥Îìú Î†åÎçîÎßÅ
   */
  render() {
    if (!this.container) {
      console.warn('‚ö†Ô∏è StatCard: containerÍ∞Ä ÏóÜÏñ¥ÏÑú Î†åÎçîÎßÅÏùÑ Í±¥ÎÑàÎúÅÎãàÎã§');
      return;
    }
    
    const html = this.generateHTML();
    
    if (this.container.tagName === 'DIV' && this.container.classList.contains('stats-bar')) {
      // stats-bar Ïª®ÌÖåÏù¥ÎÑàÏóê Ï∂îÍ∞Ä
      const existingCard = this.container.querySelector(`[data-stat-id="${this.id}"]`);
      if (existingCard) {
        existingCard.outerHTML = html;
      } else {
        this.container.insertAdjacentHTML('beforeend', html);
      }
    } else {
      // Í∞úÎ≥Ñ Ïª®ÌÖåÏù¥ÎÑàÏóê Î†åÎçîÎßÅ
      this.container.innerHTML = html;
    }
    
    console.log('üé® StatCard Î†åÎçîÎßÅ ÏôÑÎ£å:', this.id);
  }
  
  /**
   * Ïù¥Î≤§Ìä∏ Î∞îÏù∏Îî©
   */
  bindEvents() {
    if (!this.clickable) return;
    
    const cardElement = this.getCardElement();
    if (!cardElement) return;
    
    // ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏
    cardElement.addEventListener('click', (e) => {
      e.preventDefault();
      this.handleClick();
    });
    
    // ÌÇ§Î≥¥Îìú Ïù¥Î≤§Ìä∏ (Ï†ëÍ∑ºÏÑ±)
    cardElement.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        this.handleClick();
      }
    });
    
    // Ìò∏Î≤Ñ Ìö®Í≥º (ÌÑ∞Ïπò ÎîîÎ∞îÏù¥Ïä§ Í≥†Î†§)
    cardElement.addEventListener('mouseenter', () => {
      cardElement.classList.add('hover');
    });
    
    cardElement.addEventListener('mouseleave', () => {
      cardElement.classList.remove('hover');
    });
    
    console.log('üéØ StatCard Ïù¥Î≤§Ìä∏ Î∞îÏù∏Îî© ÏôÑÎ£å:', this.id);
  }
  
  /**
   * Ïπ¥Îìú ÏóòÎ¶¨Î®ºÌä∏ Í∞ÄÏ†∏Ïò§Í∏∞
   */
  getCardElement() {
    if (!this.container) return null;
    
    if (this.container.classList.contains('stats-bar')) {
      return this.container.querySelector(`[data-stat-id="${this.id}"]`);
    } else {
      return this.container.querySelector('.stat-card');
    }
  }
  
  /**
   * ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏ Ï≤òÎ¶¨
   */
  handleClick() {
    console.log('üñ±Ô∏è StatCard ÌÅ¥Î¶≠:', this.id);
    
    // ÏãúÍ∞ÅÏ†Å ÌîºÎìúÎ∞±
    const cardElement = this.getCardElement();
    if (cardElement) {
      cardElement.classList.add('clicked');
      setTimeout(() => {
        cardElement.classList.remove('clicked');
      }, 200);
    }
    
    // onClick ÏΩúÎ∞± Ïã§Ìñâ
    if (typeof this.onClick === 'function') {
      try {
        this.onClick(this.id, this.value, this);
      } catch (error) {
        console.error('‚ùå StatCard onClick ÏóêÎü¨:', error);
      }
    } else if (typeof this.onClick === 'string') {
      // Ï†ÑÏó≠ Ìï®ÏàòÎ™ÖÏù∏ Í≤ΩÏö∞
      if (typeof window[this.onClick] === 'function') {
        window[this.onClick](this.id, this.value, this);
      } else {
        console.warn('‚ö†Ô∏è StatCard: Ï°¥Ïû¨ÌïòÏßÄ ÏïäÎäî Ìï®Ïàò:', this.onClick);
      }
    }
    
    // Ïª§Ïä§ÌÖÄ Ïù¥Î≤§Ìä∏ Î∞úÏÉù
    this.triggerEvent('statcard:click', {
      id: this.id,
      value: this.value,
      label: this.label
    });
  }
  
  /**
   * Í∞í ÏóÖÎç∞Ïù¥Ìä∏ (Ïï†ÎãàÎ©îÏù¥ÏÖò Ìè¨Ìï®)
   */
  updateValue(newValue, animated = this.animationEnabled) {
    const oldValue = this.value;
    this.lastValue = oldValue;
    this.value = newValue;
    this.updateCount++;
    
    console.log('üîÑ StatCard Í∞í ÏóÖÎç∞Ïù¥Ìä∏:', this.id, `${oldValue} ‚Üí ${newValue}`);
    
    const cardElement = this.getCardElement();
    if (!cardElement) {
      this.render();
      return;
    }
    
    const numberElement = cardElement.querySelector('.stat-number');
    if (!numberElement) return;
    
    if (animated && typeof oldValue === 'number' && typeof newValue === 'number') {
      this.animateValueChange(numberElement, oldValue, newValue);
    } else {
      // Ï¶âÏãú ÏóÖÎç∞Ïù¥Ìä∏
      numberElement.textContent = this.formatValue(newValue);
      numberElement.setAttribute('data-value', newValue);
      cardElement.setAttribute('aria-label', `${this.label}: ${this.formatValue(newValue)}`);
    }
    
    // Î≥ÄÌôî Î∞©Ìñ•Ïóê Îî∞Î•∏ ÏãúÍ∞ÅÏ†Å ÌîºÎìúÎ∞±
    if (typeof oldValue === 'number' && typeof newValue === 'number') {
      if (newValue > oldValue) {
        this.showChangeIndicator('increase');
      } else if (newValue < oldValue) {
        this.showChangeIndicator('decrease');
      }
    }
    
    // Ïª§Ïä§ÌÖÄ Ïù¥Î≤§Ìä∏ Î∞úÏÉù
    this.triggerEvent('statcard:update', {
      id: this.id,
      oldValue: oldValue,
      newValue: newValue,
      change: typeof oldValue === 'number' && typeof newValue === 'number' ? newValue - oldValue : null
    });
  }
  
  /**
   * Í∞í Î≥ÄÌôî Ïï†ÎãàÎ©îÏù¥ÏÖò
   */
  animateValueChange(element, from, to) {
    const duration = 1000; // 1Ï¥à
    const steps = 60; // 60 FPS
    const stepDuration = duration / steps;
    const stepValue = (to - from) / steps;
    
    let currentStep = 0;
    let currentValue = from;
    
    const animate = () => {
      currentStep++;
      currentValue += stepValue;
      
      if (currentStep >= steps) {
        currentValue = to;
        element.textContent = this.formatValue(to);
        element.setAttribute('data-value', to);
        return;
      }
      
      element.textContent = this.formatValue(Math.round(currentValue));
      element.setAttribute('data-value', Math.round(currentValue));
      
      setTimeout(animate, stepDuration);
    };
    
    animate();
  }
  
  /**
   * Î≥ÄÌôî Î∞©Ìñ• ÌëúÏãú
   */
  showChangeIndicator(direction) {
    const cardElement = this.getCardElement();
    if (!cardElement) return;
    
    // Í∏∞Ï°¥ Ïù∏ÎîîÏºÄÏù¥ÌÑ∞ Ï†úÍ±∞
    const existingIndicator = cardElement.querySelector('.change-indicator');
    if (existingIndicator) {
      existingIndicator.remove();
    }
    
    // ÏÉà Ïù∏ÎîîÏºÄÏù¥ÌÑ∞ Ï∂îÍ∞Ä
    const indicator = document.createElement('div');
    indicator.className = `change-indicator ${direction}`;
    indicator.innerHTML = direction === 'increase' ? '‚ÜóÔ∏è' : '‚ÜòÔ∏è';
    indicator.setAttribute('aria-hidden', 'true');
    
    cardElement.appendChild(indicator);
    
    // 2Ï¥à ÌõÑ Ï†úÍ±∞
    setTimeout(() => {
      indicator.remove();
    }, 2000);
  }
  
  /**
   * Î°úÎî© ÏÉÅÌÉú ÏÑ§Ï†ï
   */
  setLoading(loading = true) {
    this.isLoading = loading;
    
    const cardElement = this.getCardElement();
    if (cardElement) {
      if (loading) {
        cardElement.classList.add('loading');
        // Î°úÎçî Ï∂îÍ∞Ä
        if (!cardElement.querySelector('.stat-loader')) {
          const loader = document.createElement('div');
          loader.className = 'stat-loader';
          cardElement.insertBefore(loader, cardElement.firstChild);
        }
      } else {
        cardElement.classList.remove('loading');
        const loader = cardElement.querySelector('.stat-loader');
        if (loader) {
          loader.remove();
        }
      }
    }
    
    console.log('‚è≥ StatCard Î°úÎî© ÏÉÅÌÉú:', this.id, loading);
  }
  
  /**
   * ÎùºÎ≤® ÏóÖÎç∞Ïù¥Ìä∏
   */
  updateLabel(newLabel) {
    this.label = newLabel;
    
    const cardElement = this.getCardElement();
    if (cardElement) {
      const labelElement = cardElement.querySelector('.stat-label');
      if (labelElement) {
        labelElement.textContent = newLabel;
      }
      cardElement.setAttribute('aria-label', `${newLabel}: ${this.formatValue(this.value)}`);
    }
    
    console.log('üè∑Ô∏è StatCard ÎùºÎ≤® ÏóÖÎç∞Ïù¥Ìä∏:', this.id, newLabel);
  }
  
  /**
   * ÏïÑÏù¥ÏΩò ÏóÖÎç∞Ïù¥Ìä∏
   */
  updateIcon(newIcon) {
    this.icon = newIcon;
    
    const cardElement = this.getCardElement();
    if (cardElement) {
      const iconElement = cardElement.querySelector('.stat-icon');
      if (iconElement) {
        iconElement.textContent = newIcon;
      }
    }
    
    console.log('üé≠ StatCard ÏïÑÏù¥ÏΩò ÏóÖÎç∞Ïù¥Ìä∏:', this.id, newIcon);
  }
  
  /**
   * ÏÉâÏÉÅ Î≥ÄÍ≤Ω
   */
  updateColor(newColor) {
    const cardElement = this.getCardElement();
    if (cardElement) {
      // Í∏∞Ï°¥ ÏÉâÏÉÅ ÌÅ¥ÎûòÏä§ Ï†úÍ±∞
      cardElement.classList.remove(`stat-card-${this.color}`);
      // ÏÉà ÏÉâÏÉÅ ÌÅ¥ÎûòÏä§ Ï∂îÍ∞Ä
      cardElement.classList.add(`stat-card-${newColor}`);
      cardElement.setAttribute('data-color', newColor);
    }
    
    this.color = newColor;
    console.log('üé® StatCard ÏÉâÏÉÅ Î≥ÄÍ≤Ω:', this.id, newColor);
  }
  
  /**
   * ÌÅ¥Î¶≠ Í∞ÄÎä• ÏÉÅÌÉú Î≥ÄÍ≤Ω
   */
  setClickable(clickable) {
    this.clickable = clickable;
    
    const cardElement = this.getCardElement();
    if (cardElement) {
      if (clickable) {
        cardElement.classList.add('clickable');
        cardElement.setAttribute('role', 'button');
        cardElement.setAttribute('tabindex', '0');
        cardElement.setAttribute('title', 'ÌÅ¥Î¶≠ÌïòÏó¨ ÏÉÅÏÑ∏Î≥¥Í∏∞');
        
        // ÌÅ¥Î¶≠ ÌûåÌä∏ Ï∂îÍ∞Ä
        if (!cardElement.querySelector('.stat-click-hint')) {
          const hint = document.createElement('div');
          hint.className = 'stat-click-hint';
          hint.textContent = 'ÌÅ¥Î¶≠';
          hint.setAttribute('aria-hidden', 'true');
          cardElement.appendChild(hint);
        }
        
        this.bindEvents();
      } else {
        cardElement.classList.remove('clickable');
        cardElement.setAttribute('role', 'status');
        cardElement.setAttribute('tabindex', '-1');
        cardElement.setAttribute('title', this.label);
        
        // ÌÅ¥Î¶≠ ÌûåÌä∏ Ï†úÍ±∞
        const hint = cardElement.querySelector('.stat-click-hint');
        if (hint) {
          hint.remove();
        }
      }
    }
    
    console.log('üëÜ StatCard ÌÅ¥Î¶≠ Í∞ÄÎä• ÏÉÅÌÉú:', this.id, clickable);
  }
  
  /**
   * Ïª§Ïä§ÌÖÄ Ïù¥Î≤§Ìä∏ Î∞úÏÉù
   */
  triggerEvent(eventType, detail) {
    if (this.container) {
      const event = new CustomEvent(eventType, {
        detail: detail,
        bubbles: true
      });
      this.container.dispatchEvent(event);
    }
  }
  
  /**
   * ÌòÑÏû¨ ÏÉÅÌÉú Í∞ÄÏ†∏Ïò§Í∏∞
   */
  getState() {
    return {
      id: this.id,
      value: this.value,
      label: this.label,
      icon: this.icon,
      color: this.color,
      clickable: this.clickable,
      isLoading: this.isLoading,
      lastValue: this.lastValue,
      updateCount: this.updateCount
    };
  }
  
  /**
   * Ïª¥Ìè¨ÎÑåÌä∏ Ï†úÍ±∞
   */
  destroy() {
    const cardElement = this.getCardElement();
    if (cardElement) {
      cardElement.remove();
    }
    
    console.log('üóëÔ∏è StatCard Ï†úÍ±∞ ÏôÑÎ£å:', this.id);
  }
}

/**
 * StatCardManager - Ïó¨Îü¨ StatCardÎ•º Í¥ÄÎ¶¨ÌïòÎäî Îß§ÎãàÏ†Ä
 */
class StatCardManager {
  constructor(container) {
    this.container = typeof container === 'string' ? document.querySelector(container) : container;
    this.cards = new Map();
    
    if (this.container) {
      this.container.classList.add('stats-bar');
    }
    
    console.log('üìä StatCardManager Ï¥àÍ∏∞Ìôî ÏôÑÎ£å');
  }
  
  /**
   * Ïπ¥Îìú Ï∂îÍ∞Ä
   */
  addCard(config) {
    const card = new StatCard(config, this.container);
    this.cards.set(config.id, card);
    return card;
  }
  
  /**
   * Ïπ¥Îìú Í∞ÄÏ†∏Ïò§Í∏∞
   */
  getCard(id) {
    return this.cards.get(id);
  }
  
  /**
   * Ïπ¥Îìú Ï†úÍ±∞
   */
  removeCard(id) {
    const card = this.cards.get(id);
    if (card) {
      card.destroy();
      this.cards.delete(id);
      return true;
    }
    return false;
  }
  
  /**
   * Î™®Îì† Ïπ¥Îìú Í∞í ÏóÖÎç∞Ïù¥Ìä∏
   */
  updateAll(values) {
    for (const [id, value] of Object.entries(values)) {
      const card = this.cards.get(id);
      if (card) {
        card.updateValue(value);
      }
    }
  }
  
  /**
   * Î™®Îì† Ïπ¥Îìú Ï†úÍ±∞
   */
  clear() {
    this.cards.forEach(card => card.destroy());
    this.cards.clear();
  }
}

// Î∏åÎùºÏö∞Ï†Ä ÌôòÍ≤ΩÏóêÏÑú Ï†ÑÏó≠ÏúºÎ°ú ÏÇ¨Ïö© Í∞ÄÎä•ÌïòÍ≤å
if (typeof window !== 'undefined') {
  window.StatCard = StatCard;
  window.StatCardManager = StatCardManager;
}

// Node.js ÌôòÍ≤ΩÏóêÏÑú export
if (typeof module !== 'undefined' && module.exports) {
  module.exports = { StatCard, StatCardManager };
}

export { StatCard, StatCardManager };