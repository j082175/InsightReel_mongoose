const { chromium } = require('playwright');
const fs = require('fs');
const path = require('path');

async function extractInstagramCookies() {
    console.log('ðŸ¤– Playwrightë¡œ Instagram ì¿ í‚¤ ì¶”ì¶œ ì‹œìž‘...');

    const browser = await chromium.launch({
        headless: false, // ë¡œê·¸ì¸ ê³¼ì •ì„ ë³´ê¸° ìœ„í•´ ë¸Œë¼ìš°ì €ë¥¼ í‘œì‹œ
        slowMo: 1000    // ê° ë™ìž‘ ì‚¬ì´ì— 1ì´ˆ ì§€ì—°
    });

    const context = await browser.newContext({
        userAgent: 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36'
    });

    const page = await context.newPage();

    try {
        // Instagram ë¡œê·¸ì¸ íŽ˜ì´ì§€ë¡œ ì´ë™
        console.log('ðŸ“¸ Instagram ë¡œê·¸ì¸ íŽ˜ì´ì§€ ì´ë™...');
        await page.goto('https://www.instagram.com/accounts/login/', {
            waitUntil: 'networkidle'
        });

        // ë¡œê·¸ì¸ ì •ë³´ ìž…ë ¥
        console.log('ðŸ”‘ ë¡œê·¸ì¸ ì •ë³´ ìž…ë ¥...');
        await page.fill('input[name="username"]', 'j082175j082172@gmail.com');
        await page.fill('input[name="password"]', '!@tkadnjsth3');

        // ë¡œê·¸ì¸ ë²„íŠ¼ í´ë¦­
        console.log('ðŸ‘† ë¡œê·¸ì¸ ë²„íŠ¼ í´ë¦­...');
        await page.click('button[type="submit"]');

        // ë¡œê·¸ì¸ ì™„ë£Œ ëŒ€ê¸° (í™ˆíŽ˜ì´ì§€ ë¡œë“œ í™•ì¸)
        console.log('â³ ë¡œê·¸ì¸ ì™„ë£Œ ëŒ€ê¸°...');
        await page.waitForURL('https://www.instagram.com/', {
            timeout: 30000
        });

        console.log('âœ… ë¡œê·¸ì¸ ì„±ê³µ!');

        // 2FA ë˜ëŠ” ì¶”ê°€ í™•ì¸ì´ ìžˆëŠ” ê²½ìš° ì‚¬ìš©ìž ìž…ë ¥ ëŒ€ê¸°
        const currentUrl = page.url();
        if (currentUrl.includes('challenge') || currentUrl.includes('accounts/onetap')) {
            console.log('ðŸ” ì¶”ê°€ ì¸ì¦ì´ í•„ìš”í•©ë‹ˆë‹¤. ë¸Œë¼ìš°ì €ì—ì„œ ì™„ë£Œí•´ì£¼ì„¸ìš”...');
            console.log('ì™„ë£Œë˜ë©´ ì•„ë¬´ í‚¤ë‚˜ ëˆ„ë¥´ì„¸ìš”.');

            // ì‚¬ìš©ìž ìž…ë ¥ ëŒ€ê¸°
            process.stdin.setRawMode(true);
            process.stdin.resume();
            await new Promise(resolve => process.stdin.once('data', resolve));
            process.stdin.setRawMode(false);
            process.stdin.pause();
        }

        // ì¿ í‚¤ ì¶”ì¶œ
        console.log('ðŸª ì¿ í‚¤ ì¶”ì¶œ ì¤‘...');
        const cookies = await context.cookies();

        // Netscape í˜•ì‹ìœ¼ë¡œ ì¿ í‚¤ íŒŒì¼ ìƒì„±
        const cookieLines = [
            '# Netscape HTTP Cookie File',
            '# Generated by Instagram Cookie Extractor'
        ];

        cookies.forEach(cookie => {
            if (cookie.domain.includes('instagram.com')) {
                const line = [
                    cookie.domain,
                    cookie.domain.startsWith('.') ? 'TRUE' : 'FALSE',
                    cookie.path,
                    cookie.secure ? 'TRUE' : 'FALSE',
                    Math.floor(cookie.expires || Date.now() / 1000 + 86400 * 30), // 30ì¼ í›„ ë§Œë£Œ
                    cookie.name,
                    cookie.value
                ].join('\t');
                cookieLines.push(line);
            }
        });

        // ì¿ í‚¤ íŒŒì¼ ì €ìž¥
        const cookieFilePath = path.join(__dirname, '../../data/instagram_cookies.txt');
        fs.writeFileSync(cookieFilePath, cookieLines.join('\n'));

        console.log(`âœ… ì¿ í‚¤ íŒŒì¼ ì €ìž¥ ì™„ë£Œ: ${cookieFilePath}`);
        console.log(`ðŸ“Š ì¶”ì¶œëœ ì¿ í‚¤ ìˆ˜: ${cookies.filter(c => c.domain.includes('instagram.com')).length}ê°œ`);

        // ì¤‘ìš”í•œ ì¿ í‚¤ë“¤ í™•ì¸
        const importantCookies = ['sessionid', 'csrftoken', 'mid', 'ig_did'];
        importantCookies.forEach(cookieName => {
            const cookie = cookies.find(c => c.name === cookieName && c.domain.includes('instagram.com'));
            if (cookie) {
                console.log(`âœ… ${cookieName}: ì¡´ìž¬`);
            } else {
                console.log(`âŒ ${cookieName}: ì—†ìŒ`);
            }
        });

    } catch (error) {
        console.error('âŒ ì¿ í‚¤ ì¶”ì¶œ ì‹¤íŒ¨:', error.message);

        // ìŠ¤í¬ë¦°ìƒ· ì €ìž¥ (ë””ë²„ê¹…ìš©)
        await page.screenshot({
            path: path.join(__dirname, '../../data/instagram_error.png')
        });

    } finally {
        console.log('ðŸ”š ë¸Œë¼ìš°ì € ì¢…ë£Œ...');
        await browser.close();
    }
}

// ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
if (require.main === module) {
    extractInstagramCookies()
        .then(() => {
            console.log('ðŸŽ‰ Instagram ì¿ í‚¤ ì¶”ì¶œ ì™„ë£Œ!');
            process.exit(0);
        })
        .catch(error => {
            console.error('ðŸ’¥ ì¿ í‚¤ ì¶”ì¶œ ì‹¤íŒ¨:', error);
            process.exit(1);
        });
}

module.exports = { extractInstagramCookies };